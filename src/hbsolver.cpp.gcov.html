<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - qucs-core-0.0.19 Code Coverage - src/hbsolver.cpp</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">src</a> - hbsolver.cpp<span style="font-size: 80%;"> (source / <a href="hbsolver.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">qucs-core-0.0.19 Code Coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">568</td>
            <td class="headerCovTableEntry">642</td>
            <td class="headerCovTableEntryMed">88.5 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2015-01-05 16:01:02</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">37</td>
            <td class="headerCovTableEntry">46</td>
            <td class="headerCovTableEntryMed">80.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
            | Branches:
            <span class="coverLegendCov">+</span> taken
            <span class="coverLegendNoCov">-</span> not taken
            <span class="coverLegendNoCov">#</span> not executed
</td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">587</td>
            <td class="headerCovTableEntry">1182</td>
            <td class="headerCovTableEntryLo">49.7 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /*</a>
<span class="lineNum">       2 </span>                :            :  * hbsolver.cpp - harmonic balance solver class implementation
<span class="lineNum">       3 </span>                :            :  *
<span class="lineNum">       4 </span>                :            :  * Copyright (C) 2005, 2006, 2007, 2008 Stefan Jahn &lt;stefan@lkcc.org&gt;
<span class="lineNum">       5 </span>                :            :  *
<span class="lineNum">       6 </span>                :            :  * This is free software; you can redistribute it and/or modify
<span class="lineNum">       7 </span>                :            :  * it under the terms of the GNU General Public License as published by
<span class="lineNum">       8 </span>                :            :  * the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">       9 </span>                :            :  * any later version.
<span class="lineNum">      10 </span>                :            :  *
<span class="lineNum">      11 </span>                :            :  * This software is distributed in the hope that it will be useful,
<span class="lineNum">      12 </span>                :            :  * but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      13 </span>                :            :  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      14 </span>                :            :  * GNU General Public License for more details.
<span class="lineNum">      15 </span>                :            :  *
<span class="lineNum">      16 </span>                :            :  * You should have received a copy of the GNU General Public License
<span class="lineNum">      17 </span>                :            :  * along with this package; see the file COPYING.  If not, write to
<span class="lineNum">      18 </span>                :            :  * the Free Software Foundation, Inc., 51 Franklin Street - Fifth Floor,
<span class="lineNum">      19 </span>                :            :  * Boston, MA 02110-1301, USA.
<span class="lineNum">      20 </span>                :            :  *
<span class="lineNum">      21 </span>                :            :  * $Id$
<span class="lineNum">      22 </span>                :            :  *
<span class="lineNum">      23 </span>                :            :  */
<span class="lineNum">      24 </span>                :            : 
<span class="lineNum">      25 </span>                :            : #if HAVE_CONFIG_H
<span class="lineNum">      26 </span>                :            : # include &lt;config.h&gt;
<span class="lineNum">      27 </span>                :            : #endif
<span class="lineNum">      28 </span>                :            : 
<span class="lineNum">      29 </span>                :            : #include &lt;stdio.h&gt;
<span class="lineNum">      30 </span>                :            : 
<span class="lineNum">      31 </span>                :            : #include &quot;object.h&quot;
<span class="lineNum">      32 </span>                :            : #include &quot;logging.h&quot;
<span class="lineNum">      33 </span>                :            : #include &quot;complex.h&quot;
<span class="lineNum">      34 </span>                :            : #include &quot;vector.h&quot;
<span class="lineNum">      35 </span>                :            : #include &quot;node.h&quot;
<span class="lineNum">      36 </span>                :            : #include &quot;circuit.h&quot;
<span class="lineNum">      37 </span>                :            : #include &quot;component_id.h&quot;
<span class="lineNum">      38 </span>                :            : #include &quot;net.h&quot;
<span class="lineNum">      39 </span>                :            : #include &quot;netdefs.h&quot;
<span class="lineNum">      40 </span>                :            : #include &quot;strlist.h&quot;
<span class="lineNum">      41 </span>                :            : #include &quot;ptrlist.h&quot;
<span class="lineNum">      42 </span>                :            : #include &quot;tvector.h&quot;
<span class="lineNum">      43 </span>                :            : #include &quot;tmatrix.h&quot;
<span class="lineNum">      44 </span>                :            : #include &quot;eqnsys.h&quot;
<span class="lineNum">      45 </span>                :            : #include &quot;analysis.h&quot;
<span class="lineNum">      46 </span>                :            : #include &quot;dataset.h&quot;
<span class="lineNum">      47 </span>                :            : #include &quot;fourier.h&quot;
<span class="lineNum">      48 </span>                :            : #include &quot;hbsolver.h&quot;
<span class="lineNum">      49 </span>                :            : 
<span class="lineNum">      50 </span>                :            : #define HB_DEBUG 0
<span class="lineNum">      51 </span>                :            : 
<span class="lineNum">      52 </span>                :            : namespace qucs {
<span class="lineNum">      53 </span>                :            : 
<span class="lineNum">      54 </span>                :            : using namespace fourier;
<a name="55"><span class="lineNum">      55 </span>                :            : </a>
<span class="lineNum">      56 </span>                :            : // Constructor creates an unnamed instance of the hbsolver class.
<span class="lineNum">      57 </span>[<span class="branchCov" title="Branch 5 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>][<span class="branchCov" title="Branch 8 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>]:<span class="lineCov">          1 : hbsolver::hbsolver () : analysis () {</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 11 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span>][<span class="branchNoExec" title="Branch 27 was not executed"> # </span><span class="branchNoExec" title="Branch 28 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 30 was not executed"> # </span><span class="branchNoExec" title="Branch 31 was not executed"> # </span>][<span class="branchNoExec" title="Branch 33 was not executed"> # </span><span class="branchNoExec" title="Branch 34 was not executed"> # </span>]
<span class="lineNum">      58 </span>                :<span class="lineCov">          1 :   type = ANALYSIS_HBALANCE;</span>
<span class="lineNum">      59 </span>                :<span class="lineCov">          1 :   frequency = 0;</span>
<span class="lineNum">      60 </span>                :<span class="lineCov">          1 :   nlnodes = lnnodes = banodes = nanodes = NULL;</span>
<span class="lineNum">      61 </span>                :<span class="lineCov">          1 :   Y = Z = A = NULL;</span>
<span class="lineNum">      62 </span>                :<span class="lineCov">          1 :   NA = YV = JQ = JG = JF = NULL;</span>
<span class="lineNum">      63 </span>                :<span class="lineCov">          1 :   OM = IR = QR = RH = IG = FQ = VS = VP = FV = IL = IN = IC = IS = NULL;</span>
<span class="lineNum">      64 </span>                :<span class="lineCov">          1 :   vs = x = NULL;</span>
<span class="lineNum">      65 </span>                :<span class="lineCov">          1 :   runs = 0;</span>
<span class="lineNum">      66 </span>                :<span class="lineCov">          1 :   ndfreqs = NULL;</span>
<span class="lineNum">      67 </span>                :<span class="lineCov">          1 : }</span>
<a name="68"><span class="lineNum">      68 </span>                :            : </a>
<span class="lineNum">      69 </span>                :            : // Constructor creates a named instance of the hbsolver class.
<span class="lineNum">      70 </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]:<span class="lineNoCov">          0 : hbsolver::hbsolver (char * n) : analysis (n) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 11 was not executed"> # </span><span class="branchNoExec" title="Branch 12 was not executed"> # </span>][<span class="branchNoExec" title="Branch 27 was not executed"> # </span><span class="branchNoExec" title="Branch 28 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 30 was not executed"> # </span><span class="branchNoExec" title="Branch 31 was not executed"> # </span>][<span class="branchNoExec" title="Branch 33 was not executed"> # </span><span class="branchNoExec" title="Branch 34 was not executed"> # </span>]
<span class="lineNum">      71 </span>                :<span class="lineNoCov">          0 :   type = ANALYSIS_HBALANCE;</span>
<span class="lineNum">      72 </span>                :<span class="lineNoCov">          0 :   frequency = 0;</span>
<span class="lineNum">      73 </span>                :<span class="lineNoCov">          0 :   nlnodes = lnnodes = banodes = nanodes = NULL;</span>
<span class="lineNum">      74 </span>                :<span class="lineNoCov">          0 :   Y = Z = A = NULL;</span>
<span class="lineNum">      75 </span>                :<span class="lineNoCov">          0 :   NA = YV = JQ = JG = JF = NULL;</span>
<span class="lineNum">      76 </span>                :<span class="lineNoCov">          0 :   OM = IR = QR = RH = IG = FQ = VS = VP = FV = IL = IN = IC = IS = NULL;</span>
<span class="lineNum">      77 </span>                :<span class="lineNoCov">          0 :   vs = x = NULL;</span>
<span class="lineNum">      78 </span>                :<span class="lineNoCov">          0 :   runs = 0;</span>
<span class="lineNum">      79 </span>                :<span class="lineNoCov">          0 :   ndfreqs = NULL;</span>
<span class="lineNum">      80 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="81"><span class="lineNum">      81 </span>                :            : </a>
<span class="lineNum">      82 </span>                :            : // Destructor deletes the hbsolver class object.
<span class="lineNum">      83 </span>                :<span class="lineCov">          1 : hbsolver::~hbsolver () {</span>
<span class="lineNum">      84 </span>                :            :   // delete nodelists
<span class="lineNum">      85 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (nlnodes) delete nlnodes;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>][<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>]
<span class="lineNum">      86 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (lnnodes) delete lnnodes;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>][<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>]
<span class="lineNum">      87 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (banodes) delete banodes;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>][<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>]
<span class="lineNum">      88 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (nanodes) delete nanodes;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>][<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>]
<span class="lineNum">      89 </span>                :            : 
<span class="lineNum">      90 </span>                :            :   // delete temporary matrices
<span class="lineNum">      91 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          1 :   if (A) delete A;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">      92 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          1 :   if (Z) delete Z;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">      93 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          1 :   if (Y) delete Y;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">      94 </span>                :            : 
<span class="lineNum">      95 </span>                :            :   // delete matrices
<span class="lineNum">      96 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (NA) delete NA;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">      97 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (YV) delete YV;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">      98 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (JQ) delete JQ;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">      99 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (JG) delete JG;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     100 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (JF) delete JF;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     101 </span>                :            : 
<span class="lineNum">     102 </span>                :            :   // delete vectors
<span class="lineNum">     103 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (IC) delete IC;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     104 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (IS) delete IS;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     105 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (FV) delete FV;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     106 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (IL) delete IL;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     107 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (IN) delete IN;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     108 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (IG) delete IG;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     109 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (FQ) delete FQ;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     110 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (VS) delete VS;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     111 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (VP) delete VP;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     112 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (vs) delete vs;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     113 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (OM) delete OM;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     114 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (IR) delete IR;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     115 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (QR) delete QR;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     116 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (RH) delete RH;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     117 </span>                :            : 
<span class="lineNum">     118 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (x) delete x;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     119 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (ndfreqs) delete[] ndfreqs;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">     120 </span>[<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>][<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]:<span class="lineCov">          2 : }</span>
<span class="lineNum">     121 </span>                :            : 
<a name="122"><span class="lineNum">     122 </span>                :            : /* The copy constructor creates a new instance of the hbsolver class</a>
<span class="lineNum">     123 </span>                :            :    based on the given hbsolver object. */
<span class="lineNum">     124 </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]:<span class="lineNoCov">          0 : hbsolver::hbsolver (hbsolver &amp; o) : analysis (o) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 11 was not executed"> # </span><span class="branchNoExec" title="Branch 12 was not executed"> # </span>][<span class="branchNoExec" title="Branch 28 was not executed"> # </span><span class="branchNoExec" title="Branch 29 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 31 was not executed"> # </span><span class="branchNoExec" title="Branch 32 was not executed"> # </span>][<span class="branchNoExec" title="Branch 34 was not executed"> # </span><span class="branchNoExec" title="Branch 35 was not executed"> # </span>]
<span class="lineNum">     125 </span>                :<span class="lineNoCov">          0 :   frequency = o.frequency;</span>
<span class="lineNum">     126 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :   negfreqs = o.negfreqs;</span>
<span class="lineNum">     127 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :   posfreqs = o.posfreqs;</span>
<span class="lineNum">     128 </span>                :<span class="lineNoCov">          0 :   nlnodes = o.nlnodes;</span>
<span class="lineNum">     129 </span>                :<span class="lineNoCov">          0 :   lnnodes = o.lnnodes;</span>
<span class="lineNum">     130 </span>                :<span class="lineNoCov">          0 :   banodes = o.banodes;</span>
<span class="lineNum">     131 </span>                :<span class="lineNoCov">          0 :   nanodes = o.nanodes;</span>
<span class="lineNum">     132 </span>                :<span class="lineNoCov">          0 :   Y = Z = A = NULL;</span>
<span class="lineNum">     133 </span>                :<span class="lineNoCov">          0 :   NA = YV = JQ = JG = JF = NULL;</span>
<span class="lineNum">     134 </span>                :<span class="lineNoCov">          0 :   OM = IR = QR = RH = IG = FQ = VS = VP = FV = IL = IN = IC = IS = NULL;</span>
<span class="lineNum">     135 </span>                :<span class="lineNoCov">          0 :   vs = x = NULL;</span>
<span class="lineNum">     136 </span>                :<span class="lineNoCov">          0 :   runs = o.runs;</span>
<span class="lineNum">     137 </span>                :<span class="lineNoCov">          0 :   ndfreqs = NULL;</span>
<span class="lineNum">     138 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     139 </span>                :            : 
<span class="lineNum">     140 </span>                :            : #define VS_(r) (*VS) (r)
<span class="lineNum">     141 </span>                :            : #define OM_(r) (*OM) (r)
<span class="lineNum">     142 </span>                :            : 
<a name="143"><span class="lineNum">     143 </span>                :            : /* This is the HB netlist solver.  It prepares the circuit list and</a>
<span class="lineNum">     144 </span>                :            :    solves it then. */
<span class="lineNum">     145 </span>                :<span class="lineCov">          1 : int hbsolver::solve (void) {</span>
<span class="lineNum">     146 </span>                :            : 
<span class="lineNum">     147 </span>                :<span class="lineCov">          1 :   int iterations = 0, done = 0;</span>
<span class="lineNum">     148 </span>                :<span class="lineCov">          1 :   int MaxIterations = getPropertyInteger (&quot;MaxIter&quot;);</span>
<span class="lineNum">     149 </span>                :            : 
<span class="lineNum">     150 </span>                :            :   // collect different parts of the circuit
<span class="lineNum">     151 </span>                :<span class="lineCov">          1 :   splitCircuits ();</span>
<span class="lineNum">     152 </span>                :            : 
<span class="lineNum">     153 </span>                :            :   // create frequency array
<span class="lineNum">     154 </span>                :<span class="lineCov">          1 :   collectFrequencies ();</span>
<span class="lineNum">     155 </span>                :            : 
<span class="lineNum">     156 </span>                :            :   // find interconnects between the linear and non-linear subcircuit
<span class="lineNum">     157 </span>                :<span class="lineCov">          1 :   getNodeLists ();</span>
<span class="lineNum">     158 </span>                :            : 
<span class="lineNum">     159 </span>                :            :   // prepares the linear part --&gt; 0 = IC + [YV] * VS
<span class="lineNum">     160 </span>                :<span class="lineCov">          1 :   prepareLinear ();</span>
<span class="lineNum">     161 </span>                :            : 
<span class="lineNum">     162 </span>                :<span class="lineCov">          1 :   runs++;</span>
<span class="lineNum">     163 </span>                :            :   logprint (LOG_STATUS, &quot;NOTIFY: %s: solving for %d frequencies\n&quot;,
<span class="lineNum">     164 </span>                :<span class="lineCov">          1 :             getName (), lnfreqs);</span>
<span class="lineNum">     165 </span>                :            : 
<span class="lineNum">     166 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (nbanodes &gt; 0) {</span>
<span class="lineNum">     167 </span>                :            : 
<span class="lineNum">     168 </span>                :            :     // start balancing
<span class="lineNum">     169 </span>                :            :     logprint (LOG_STATUS, &quot;NOTIFY: %s: balancing at %d nodes\n&quot;, getName (),
<span class="lineNum">     170 </span>                :<span class="lineCov">          1 :               nbanodes);</span>
<span class="lineNum">     171 </span>                :            : 
<span class="lineNum">     172 </span>                :            :     // prepares the non-linear part
<span class="lineNum">     173 </span>                :<span class="lineCov">          1 :     prepareNonLinear ();</span>
<span class="lineNum">     174 </span>                :            : 
<span class="lineNum">     175 </span>                :            : #if HB_DEBUG
<span class="lineNum">     176 </span>                :            :       fprintf (stderr, &quot;YV -- transY in f:\n&quot;); YV-&gt;print ();
<span class="lineNum">     177 </span>                :            :       fprintf (stderr, &quot;IC -- constant current in f:\n&quot;); IC-&gt;print ();
<span class="lineNum">     178 </span>                :            : #endif
<span class="lineNum">     179 </span>                :            : 
<span class="lineNum">     180 </span>                :            :     // start iteration
<span class="lineNum">     181 </span>[<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         10 :     do {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<span class="lineNum">     182 </span>                :<span class="lineCov">         11 :       iterations++;</span>
<span class="lineNum">     183 </span>                :            : 
<span class="lineNum">     184 </span>                :            : #if HB_DEBUG
<span class="lineNum">     185 </span>                :            :       fprintf (stderr, &quot;\n   -- iteration step: %d\n&quot;, iterations);
<span class="lineNum">     186 </span>                :            :       fprintf (stderr, &quot;vs -- voltage in t:\n&quot;); vs-&gt;print ();
<span class="lineNum">     187 </span>                :            : #endif
<span class="lineNum">     188 </span>                :            : 
<span class="lineNum">     189 </span>                :            :       // evaluate component functionality and fill matrices and vectors
<span class="lineNum">     190 </span>                :<span class="lineCov">         11 :       loadMatrices ();</span>
<span class="lineNum">     191 </span>                :            : 
<span class="lineNum">     192 </span>                :            : #if HB_DEBUG
<span class="lineNum">     193 </span>                :            :       fprintf (stderr, &quot;FQ -- charge in t:\n&quot;); FQ-&gt;print ();
<span class="lineNum">     194 </span>                :            :       fprintf (stderr, &quot;IG -- current in t:\n&quot;); IG-&gt;print ();
<span class="lineNum">     195 </span>                :            : #endif
<span class="lineNum">     196 </span>                :            : 
<span class="lineNum">     197 </span>                :            :       // currents into frequency domain
<span class="lineNum">     198 </span>                :<span class="lineCov">         11 :       VectorFFT (IG);</span>
<span class="lineNum">     199 </span>                :            : 
<span class="lineNum">     200 </span>                :            :       // charges into frequency domain
<span class="lineNum">     201 </span>                :<span class="lineCov">         11 :       VectorFFT (FQ);</span>
<span class="lineNum">     202 </span>                :            : 
<span class="lineNum">     203 </span>                :            :       // right hand side currents and charges into the frequency domain
<span class="lineNum">     204 </span>                :<span class="lineCov">         11 :       VectorFFT (IR);</span>
<span class="lineNum">     205 </span>                :<span class="lineCov">         11 :       VectorFFT (QR);</span>
<span class="lineNum">     206 </span>                :            : 
<span class="lineNum">     207 </span>                :            : #if HB_DEBUG
<span class="lineNum">     208 </span>                :            :       fprintf (stderr, &quot;VS -- voltage in f:\n&quot;); VS-&gt;print ();
<span class="lineNum">     209 </span>                :            :       fprintf (stderr, &quot;FQ -- charge in f:\n&quot;); FQ-&gt;print ();
<span class="lineNum">     210 </span>                :            :       fprintf (stderr, &quot;IG -- current in f:\n&quot;); IG-&gt;print ();
<span class="lineNum">     211 </span>                :            :       fprintf (stderr, &quot;IR -- corrected Jacobi current in f:\n&quot;); IR-&gt;print ();
<span class="lineNum">     212 </span>                :            : #endif
<span class="lineNum">     213 </span>                :            : 
<span class="lineNum">     214 </span>                :            :       // solve HB equation --&gt; FV = IC + [YV] * VS + j[O] * FQ + IG
<span class="lineNum">     215 </span>                :<span class="lineCov">         11 :       solveHB ();</span>
<span class="lineNum">     216 </span>                :            : 
<span class="lineNum">     217 </span>                :            : #if HB_DEBUG
<span class="lineNum">     218 </span>                :            :       fprintf (stderr, &quot;FV -- error vector F(V) in f:\n&quot;); FV-&gt;print ();
<span class="lineNum">     219 </span>                :            :       fprintf (stderr, &quot;IL -- linear currents in f:\n&quot;); IL-&gt;print ();
<span class="lineNum">     220 </span>                :            :       fprintf (stderr, &quot;IN -- non-linear currents in f:\n&quot;); IN-&gt;print ();
<span class="lineNum">     221 </span>                :            :       fprintf (stderr, &quot;RH -- right-hand side currents in f:\n&quot;); RH-&gt;print ();
<span class="lineNum">     222 </span>                :            : #endif
<span class="lineNum">     223 </span>                :            : 
<span class="lineNum">     224 </span>                :            :       // termination criteria met
<span class="lineNum">     225 </span>[<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchCov" title="Branch 4 was taken 9 times"> + </span>]:<span class="lineCov">         11 :       if (iterations &gt; 1 &amp;&amp; checkBalance ()) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken 1 time"> + </span><span class="branchCov" title="Branch 6 was taken 10 times"> + </span>]
<span class="lineNum">     226 </span>                :<span class="lineCov">          1 :         done = 1;</span>
<span class="lineNum">     227 </span>                :<span class="lineCov">          1 :         break;</span>
<span class="lineNum">     228 </span>                :            :       }
<span class="lineNum">     229 </span>                :            : 
<span class="lineNum">     230 </span>                :            : #if HB_DEBUG
<span class="lineNum">     231 </span>                :            :       fprintf (stderr, &quot;JG -- G-Jacobian in t:\n&quot;); JG-&gt;print ();
<span class="lineNum">     232 </span>                :            :       fprintf (stderr, &quot;JQ -- C-Jacobian in t:\n&quot;); JQ-&gt;print ();
<span class="lineNum">     233 </span>                :            : #endif
<span class="lineNum">     234 </span>                :            : 
<span class="lineNum">     235 </span>                :            :       // G-Jacobian into frequency domain
<span class="lineNum">     236 </span>                :<span class="lineCov">         10 :       MatrixFFT (JG);</span>
<span class="lineNum">     237 </span>                :            : 
<span class="lineNum">     238 </span>                :            :       // C-Jacobian into frequency domain
<span class="lineNum">     239 </span>                :<span class="lineCov">         10 :       MatrixFFT (JQ);</span>
<span class="lineNum">     240 </span>                :            : 
<span class="lineNum">     241 </span>                :            : #if HB_DEBUG
<span class="lineNum">     242 </span>                :            :       fprintf (stderr, &quot;JQ -- dQ/dV C-Jacobian in f:\n&quot;); JQ-&gt;print ();
<span class="lineNum">     243 </span>                :            :       fprintf (stderr, &quot;JG -- dI/dV G-Jacobian in f:\n&quot;); JG-&gt;print ();
<span class="lineNum">     244 </span>                :            : #endif
<span class="lineNum">     245 </span>                :            : 
<span class="lineNum">     246 </span>                :            :       // calculate Jacobian --&gt; JF = [YV] + j[O] * JQ + JG
<span class="lineNum">     247 </span>                :<span class="lineCov">         10 :       calcJacobian ();</span>
<span class="lineNum">     248 </span>                :            : 
<span class="lineNum">     249 </span>                :            : #if HB_DEBUG
<span class="lineNum">     250 </span>                :            :       fprintf (stderr, &quot;JF -- full Jacobian in f:\n&quot;); JF-&gt;print ();
<span class="lineNum">     251 </span>                :            : #endif
<span class="lineNum">     252 </span>                :            : 
<span class="lineNum">     253 </span>                :            :       // solve equation system --&gt; JF * VS(n+1) = JF * VS(n) - FV
<span class="lineNum">     254 </span>                :<span class="lineCov">         10 :       solveVoltages ();</span>
<span class="lineNum">     255 </span>                :            : 
<span class="lineNum">     256 </span>                :            : #if HB_DEBUG
<span class="lineNum">     257 </span>                :            :       fprintf (stderr, &quot;VS -- next voltage in f:\n&quot;); VS-&gt;print ();
<span class="lineNum">     258 </span>                :            : #endif
<span class="lineNum">     259 </span>                :            : 
<span class="lineNum">     260 </span>                :            :       // inverse FFT of frequency domain voltage vector VS(n+1)
<span class="lineNum">     261 </span>                :<span class="lineCov">         10 :       VectorIFFT (vs);</span>
<span class="lineNum">     262 </span>                :            :     }
<span class="lineNum">     263 </span>                :            :     // check termination criteria (balanced frequency domain currents)
<span class="lineNum">     264 </span>                :            :     while (!done &amp;&amp; iterations &lt; MaxIterations);
<span class="lineNum">     265 </span>                :            : 
<span class="lineNum">     266 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :     if (iterations &gt;= MaxIterations) {</span>
<span class="lineNum">     267 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :       qucs::exception * e = new qucs::exception (EXCEPTION_NO_CONVERGENCE);</span>
<span class="lineNum">     268 </span>                :            :       e-&gt;setText (&quot;no convergence in %s analysis after %d iterations&quot;,
<span class="lineNum">     269 </span>                :<span class="lineNoCov">          0 :                   getName (), iterations);</span>
<span class="lineNum">     270 </span>                :<span class="lineNoCov">          0 :       throw_exception (e);</span>
<span class="lineNum">     271 </span>                :            :       logprint (LOG_ERROR, &quot;%s: no convergence after %d iterations\n&quot;,
<span class="lineNum">     272 </span>                :<span class="lineNoCov">          0 :                 getName (), iterations);</span>
<span class="lineNum">     273 </span>                :            :     }
<span class="lineNum">     274 </span>                :            :     else {
<span class="lineNum">     275 </span>                :            :       logprint (LOG_STATUS, &quot;%s: convergence reached after %d iterations\n&quot;,
<span class="lineNum">     276 </span>                :<span class="lineCov">          1 :                 getName (), iterations);</span>
<span class="lineNum">     277 </span>                :            :     }
<span class="lineNum">     278 </span>                :            :   }
<span class="lineNum">     279 </span>                :            :   else {
<span class="lineNum">     280 </span>                :            :     // no balancing necessary
<span class="lineNum">     281 </span>                :<span class="lineNoCov">          0 :     logprint (LOG_STATUS, &quot;NOTIFY: %s: no balancing necessary\n&quot;, getName ());</span>
<span class="lineNum">     282 </span>                :            :   }
<span class="lineNum">     283 </span>                :            : 
<span class="lineNum">     284 </span>                :            :   // print exception stack
<span class="lineNum">     285 </span>                :<span class="lineCov">          1 :   estack.print ();</span>
<span class="lineNum">     286 </span>                :            : 
<span class="lineNum">     287 </span>                :            :   // apply AC analysis to the complete network in order to obtain the
<span class="lineNum">     288 </span>                :            :   // final results
<span class="lineNum">     289 </span>                :<span class="lineCov">          1 :   finalSolution ();</span>
<span class="lineNum">     290 </span>                :            : 
<span class="lineNum">     291 </span>                :            :   // save results into dataset
<span class="lineNum">     292 </span>                :<span class="lineCov">          1 :   saveResults ();</span>
<span class="lineNum">     293 </span>                :<span class="lineCov">          1 :   return 0;</span>
<span class="lineNum">     294 </span>                :            : }
<span class="lineNum">     295 </span>                :            : 
<a name="296"><span class="lineNum">     296 </span>                :            : /* Goes through the list of circuit objects and runs its calcHB()</a>
<span class="lineNum">     297 </span>                :            :    function. */
<span class="lineNum">     298 </span>                :<span class="lineNoCov">          0 : void hbsolver::calc (hbsolver * self) {</span>
<span class="lineNum">     299 </span>                :<span class="lineNoCov">          0 :   circuit * root = self-&gt;getNet()-&gt;getRoot ();</span>
<span class="lineNum">     300 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :   for (circuit * c = root; c != NULL; c = (circuit *) c-&gt;getNext ()) {</span>
<span class="lineNum">     301 </span>                :<span class="lineNoCov">          0 :     c-&gt;calcHB (self-&gt;frequency);</span>
<span class="lineNum">     302 </span>                :            :   }
<span class="lineNum">     303 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     304 </span>                :            : 
<a name="305"><span class="lineNum">     305 </span>                :            : /* Goes through the list of circuit objects and runs its initHB()</a>
<span class="lineNum">     306 </span>                :            :    function. */
<span class="lineNum">     307 </span>                :<span class="lineNoCov">          0 : void hbsolver::initHB (void) {</span>
<span class="lineNum">     308 </span>                :<span class="lineNoCov">          0 :   circuit * root = subnet-&gt;getRoot ();</span>
<span class="lineNum">     309 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :   for (circuit * c = root; c != NULL; c = (circuit *) c-&gt;getNext ()) {</span>
<span class="lineNum">     310 </span>                :<span class="lineNoCov">          0 :     c-&gt;initHB ();</span>
<span class="lineNum">     311 </span>                :            :   }
<span class="lineNum">     312 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     313 </span>                :            : 
<a name="314"><span class="lineNum">     314 </span>                :            : /* Goes through the list of circuit objects and runs its initDC()</a>
<span class="lineNum">     315 </span>                :            :    function. */
<span class="lineNum">     316 </span>                :<span class="lineNoCov">          0 : void hbsolver::initDC (void) {</span>
<span class="lineNum">     317 </span>                :<span class="lineNoCov">          0 :   circuit * root = subnet-&gt;getRoot ();</span>
<span class="lineNum">     318 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :   for (circuit * c = root; c != NULL; c = (circuit *) c-&gt;getNext ()) {</span>
<span class="lineNum">     319 </span>                :<span class="lineNoCov">          0 :     c-&gt;initDC ();</span>
<span class="lineNum">     320 </span>                :            :   }
<span class="lineNum">     321 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="322"><span class="lineNum">     322 </span>                :            : </a>
<span class="lineNum">     323 </span>                :            : // Returns true if circuit is a HB source.
<span class="lineNum">     324 </span>                :<span class="lineCov">          4 : bool hbsolver::isExcitation (circuit * c) {</span>
<span class="lineNum">     325 </span>                :<span class="lineCov">          4 :   int type = c-&gt;getType ();</span>
<span class="lineNum">     326 </span>[<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 3 times"> + </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>]:<span class="lineCov">          4 :   if (type == CIR_PAC || type == CIR_VAC || type == CIR_VDC)</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 3 times"> + </span>]
<span class="lineNum">     327 </span>                :<span class="lineCov">          1 :     return true;</span>
<span class="lineNum">     328 </span>                :<span class="lineCov">          4 :   return false;</span>
<span class="lineNum">     329 </span>                :            : }
<a name="330"><span class="lineNum">     330 </span>                :            : </a>
<span class="lineNum">     331 </span>                :            : // Expands the frequency array using the given frequency and the order.
<span class="lineNum">     332 </span>                :<span class="lineCov">          1 : void hbsolver::expandFrequencies (nr_double_t f, int n) {</span>
<span class="lineNum">     333 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   tvector&lt;nr_double_t&gt; nfreqs = negfreqs;</span>
<span class="lineNum">     334 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   tvector&lt;nr_double_t&gt; pfreqs = posfreqs;</span>
<span class="lineNum">     335 </span>                :<span class="lineCov">          1 :   int i, k, len = nfreqs.getSize ();</span>
<span class="lineNum">     336 </span>                :<span class="lineCov">          1 :   negfreqs.clear ();</span>
<span class="lineNum">     337 </span>                :<span class="lineCov">          1 :   posfreqs.clear ();</span>
<span class="lineNum">     338 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :   if (len &gt; 0) {</span>
<span class="lineNum">     339 </span>                :            :     // frequency expansion for full frequency sets
<span class="lineNum">     340 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; i &lt;= n + 1; i++) {</span>
<span class="lineNum">     341 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       for (k = 0; k &lt; len; k++) {</span>
<span class="lineNum">     342 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         negfreqs.add (i * f + nfreqs.get (k));</span>
<span class="lineNum">     343 </span>                :            :       }
<span class="lineNum">     344 </span>                :            :     }
<span class="lineNum">     345 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = -n; i &lt; 0; i++) {</span>
<span class="lineNum">     346 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       for (k = 0; k &lt; len; k++) {</span>
<span class="lineNum">     347 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         negfreqs.add (i * f + nfreqs.get (k));</span>
<span class="lineNum">     348 </span>                :            :       }
<span class="lineNum">     349 </span>                :            :     }
<span class="lineNum">     350 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; i &lt;= 2 * n + 1; i++) {</span>
<span class="lineNum">     351 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       for (k = 0; k &lt; len; k++) {</span>
<span class="lineNum">     352 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         posfreqs.add (i * f + pfreqs.get (k));</span>
<span class="lineNum">     353 </span>                :            :       }
<span class="lineNum">     354 </span>                :            :     }
<span class="lineNum">     355 </span>                :            :   }
<span class="lineNum">     356 </span>                :            :   else {
<span class="lineNum">     357 </span>                :            :     // first frequency
<span class="lineNum">     358 </span>        [<span class="branchCov" title="Branch 1 was taken 9 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">         10 :     for (i = 0; i &lt;= n + 1; i++) negfreqs.add (i * f);</span>
<span class="lineNum">     359 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          8 :     for (i = -n; i &lt; 0; i++) negfreqs.add (i * f);</span>
<span class="lineNum">     360 </span>        [<span class="branchCov" title="Branch 1 was taken 16 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">         17 :     for (i = 0; i &lt;= 2 * n + 1; i++) posfreqs.add (i * f);</span>
<span class="lineNum">     361 </span>                :<span class="lineCov">          1 :   }</span>
<span class="lineNum">     362 </span>                :<span class="lineCov">          1 : }</span>
<a name="363"><span class="lineNum">     363 </span>                :            : </a>
<span class="lineNum">     364 </span>                :            : // Calculates an order fulfilling the &quot;power of two&quot; requirement.
<span class="lineNum">     365 </span>                :<span class="lineCov">          1 : int hbsolver::calcOrder (int n) {</span>
<span class="lineNum">     366 </span>                :<span class="lineCov">          1 :   int o, order = n * 2;             // current order + DC + negative freqencies</span>
<span class="lineNum">     367 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          5 :   for (o = 1; o &lt; order; o &lt;&lt;= 1) ; // a power of 2</span>
<span class="lineNum">     368 </span>                :<span class="lineCov">          1 :   return o / 2 - 1;</span>
<span class="lineNum">     369 </span>                :            : }
<span class="lineNum">     370 </span>                :            : 
<span class="lineNum">     371 </span>                :            : /* The function computes the harmonic frequencies excited in the
<a name="372"><span class="lineNum">     372 </span>                :            :    circuit list depending on the maximum number of harmonics per</a>
<span class="lineNum">     373 </span>                :            :    exitation and saves its results into the 'negfreqs' vector. */
<span class="lineNum">     374 </span>                :<span class="lineCov">          1 : void hbsolver::collectFrequencies (void) {</span>
<span class="lineNum">     375 </span>                :            : 
<span class="lineNum">     376 </span>                :            :   // initialization
<span class="lineNum">     377 </span>                :<span class="lineCov">          1 :   negfreqs.clear ();</span>
<span class="lineNum">     378 </span>                :<span class="lineCov">          1 :   posfreqs.clear ();</span>
<span class="lineNum">     379 </span>                :<span class="lineCov">          1 :   rfreqs.clear ();</span>
<span class="lineNum">     380 </span>                :<span class="lineCov">          1 :   dfreqs.clear ();</span>
<span class="lineNum">     381 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          1 :   if (ndfreqs) delete[] ndfreqs;</span>
<span class="lineNum">     382 </span>                :            : 
<span class="lineNum">     383 </span>                :            :   // obtain order
<span class="lineNum">     384 </span>                :<span class="lineCov">          1 :   int i, n = calcOrder (getPropertyInteger (&quot;n&quot;));</span>
<span class="lineNum">     385 </span>                :            : 
<span class="lineNum">     386 </span>                :            :   // expand frequencies for each exitation
<span class="lineNum">     387 </span>                :            :   nr_double_t f;
<span class="lineNum">     388 </span>        [<span class="branchCov" title="Branch 5 was taken 1 time"> + </span><span class="branchCov" title="Branch 6 was taken 1 time"> + </span>]:<span class="lineCov">          2 :   for (auto * c : excitations) {</span>
<span class="lineNum">     389 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     if (c-&gt;getType () != CIR_VDC) { // no extra DC sources</span>
<span class="lineNum">     390 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :       if ((f = c-&gt;getPropertyDouble (&quot;f&quot;)) != 0.0) {</span>
<span class="lineNum">     391 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :         if (!dfreqs.contains (f)) { // no double frequencies</span>
<span class="lineNum">     392 </span>                :<span class="lineCov">          1 :           dfreqs.add (f);</span>
<span class="lineNum">     393 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :           expandFrequencies (f, n);</span>
<span class="lineNum">     394 </span>                :            :         }
<span class="lineNum">     395 </span>                :            :       }
<span class="lineNum">     396 </span>                :            :     }
<span class="lineNum">     397 </span>                :            :   }
<span class="lineNum">     398 </span>                :            : 
<span class="lineNum">     399 </span>                :            :   // no excitations
<span class="lineNum">     400 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          1 :   if (negfreqs.getSize () == 0) {</span>
<span class="lineNum">     401 </span>                :            :     // use specified frequency
<span class="lineNum">     402 </span>                :<span class="lineNoCov">          0 :     f = getPropertyDouble (&quot;f&quot;);</span>
<span class="lineNum">     403 </span>                :<span class="lineNoCov">          0 :     dfreqs.add (f);</span>
<span class="lineNum">     404 </span>                :<span class="lineNoCov">          0 :     expandFrequencies (f, n);</span>
<span class="lineNum">     405 </span>                :            :   }
<span class="lineNum">     406 </span>                :            : 
<span class="lineNum">     407 </span>                :            :   // build frequency dimension lengths
<span class="lineNum">     408 </span>                :<span class="lineCov">          1 :   ndfreqs = new int[dfreqs.getSize ()];</span>
<span class="lineNum">     409 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          2 :   for (i = 0; i &lt; dfreqs.getSize (); i++) {</span>
<span class="lineNum">     410 </span>                :<span class="lineCov">          1 :     ndfreqs[i] = (n + 1) * 2;</span>
<span class="lineNum">     411 </span>                :            :   }
<span class="lineNum">     412 </span>                :            : 
<span class="lineNum">     413 </span>                :            : #if HB_DEBUG
<span class="lineNum">     414 </span>                :            :   fprintf (stderr, &quot;%d frequencies: [ &quot;, negfreqs.getSize ());
<span class="lineNum">     415 </span>                :            :   for (i = 0; i &lt; negfreqs.getSize (); i++) {
<span class="lineNum">     416 </span>                :            :     fprintf (stderr, &quot;%g &quot;, (double) real (negfreqs.get (i)));
<span class="lineNum">     417 </span>                :            :   }
<span class="lineNum">     418 </span>                :            :   fprintf (stderr, &quot;]\n&quot;);
<span class="lineNum">     419 </span>                :            : #endif /* HB_DEBUG */
<span class="lineNum">     420 </span>                :            : 
<span class="lineNum">     421 </span>                :            :   // build list of positive frequencies including DC
<span class="lineNum">     422 </span>        [<span class="branchCov" title="Branch 1 was taken 16 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">         17 :   for (n = 0; n &lt; negfreqs.getSize (); n++) {</span>
<span class="lineNum">     423 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchCov" title="Branch 2 was taken 9 times"> + </span>]:<span class="lineCov">         16 :     if ((f = negfreqs (n)) &lt; 0.0) continue;</span>
<span class="lineNum">     424 </span>                :<span class="lineCov">          9 :     rfreqs.add (f);</span>
<span class="lineNum">     425 </span>                :            :   }
<span class="lineNum">     426 </span>                :<span class="lineCov">          1 :   lnfreqs = rfreqs.getSize ();</span>
<span class="lineNum">     427 </span>                :<span class="lineCov">          1 :   nlfreqs = negfreqs.getSize ();</span>
<span class="lineNum">     428 </span>                :            : 
<span class="lineNum">     429 </span>                :            :   // pre-calculate the j[O] vector
<span class="lineNum">     430 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   OM = new tvector&lt;nr_complex_t&gt; (nlfreqs);</span>
<span class="lineNum">     431 </span>        [<span class="branchCov" title="Branch 0 was taken 16 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         17 :   for (n = i = 0; n &lt; nlfreqs; n++, i++)</span>
<span class="lineNum">     432 </span>                :<span class="lineCov">         16 :     OM_(n) = nr_complex_t (0, 2 * M_PI * negfreqs (i));</span>
<span class="lineNum">     433 </span>                :<span class="lineCov">          1 : }</span>
<a name="434"><span class="lineNum">     434 </span>                :            : </a>
<span class="lineNum">     435 </span>                :            : // Split netlist into excitation, linear and non-linear part.
<span class="lineNum">     436 </span>                :<span class="lineCov">          1 : void hbsolver::splitCircuits (void) {</span>
<span class="lineNum">     437 </span>                :<span class="lineCov">          1 :   circuit * root = subnet-&gt;getRoot ();</span>
<span class="lineNum">     438 </span>        [<span class="branchCov" title="Branch 1 was taken 5 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          6 :   for (circuit * c = root; c != NULL; c = (circuit *) c-&gt;getNext ()) {</span>
<span class="lineNum">     439 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">          5 :     if (c-&gt;isNonLinear ()) {</span>
<span class="lineNum">     440 </span>                :            :       // non-linear part
<span class="lineNum">     441 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :       nolcircuits.push_front(c);</span>
<span class="lineNum">     442 </span>                :            :     }
<span class="lineNum">     443 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 3 times"> + </span>]:<span class="lineCov">          4 :     else if (isExcitation (c)) {</span>
<span class="lineNum">     444 </span>                :            :       // get sinusoidal sources
<span class="lineNum">     445 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :       excitations.push_front(c);</span>
<span class="lineNum">     446 </span>                :            :     }
<span class="lineNum">     447 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          3 :     else if (c-&gt;getType () != CIR_GROUND) {</span>
<span class="lineNum">     448 </span>                :            :       // linear part
<span class="lineNum">     449 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :       lincircuits.push_front (c);</span>
<span class="lineNum">     450 </span>                :            :     }
<span class="lineNum">     451 </span>                :            :   }
<span class="lineNum">     452 </span>                :<span class="lineCov">          1 : }</span>
<a name="453"><span class="lineNum">     453 </span>                :            : </a>
<span class="lineNum">     454 </span>                :            : // Creates a nodelist for the given circuit list.
<span class="lineNum">     455 </span>                :<span class="lineCov">          3 : strlist * hbsolver::circuitNodes (ptrlist&lt;circuit&gt; circuits) {</span>
<span class="lineNum">     456 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          3 :   strlist * nodes = new strlist ();</span>
<span class="lineNum">     457 </span>        [<span class="branchCov" title="Branch 5 was taken 4 times"> + </span><span class="branchCov" title="Branch 6 was taken 3 times"> + </span>]:<span class="lineCov">          7 :   for (auto * c : circuits) {</span>
<span class="lineNum">     458 </span>        [<span class="branchCov" title="Branch 1 was taken 8 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">         12 :     for (int i = 0; i &lt; c-&gt;getSize (); i++) {</span>
<span class="lineNum">     459 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          8 :       char * n = c-&gt;getNode(i)-&gt;getName ();</span>
<span class="lineNum">     460 </span>        [<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          8 :       if (strcmp (n, &quot;gnd&quot;)) {</span>
<span class="lineNum">     461 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 5 times"> + </span><span class="branchCov" title="Branch 4 was taken 1 time"> + </span>]:<span class="lineCov">          6 :         if (!nodes-&gt;contains (n)) nodes-&gt;add (n);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]
<span class="lineNum">     462 </span>                :            :       }
<span class="lineNum">     463 </span>                :            :     }
<span class="lineNum">     464 </span>                :            :   }
<span class="lineNum">     465 </span>                :<span class="lineCov">          3 :   return nodes;</span>
<span class="lineNum">     466 </span>                :            : }
<a name="467"><span class="lineNum">     467 </span>                :            : </a>
<span class="lineNum">     468 </span>                :            : // Obtain node lists for linear and non-linear part.
<span class="lineNum">     469 </span>                :<span class="lineCov">          1 : void hbsolver::getNodeLists (void) {</span>
<span class="lineNum">     470 </span>                :            :   // non-linear nodes
<span class="lineNum">     471 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   nlnodes = circuitNodes (nolcircuits);</span>
<span class="lineNum">     472 </span>                :            :   // linear nodes
<span class="lineNum">     473 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   lnnodes = circuitNodes (lincircuits);</span>
<span class="lineNum">     474 </span>                :            :   // excitation nodes
<span class="lineNum">     475 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   exnodes = circuitNodes (excitations);</span>
<span class="lineNum">     476 </span>                :            : 
<span class="lineNum">     477 </span>                :            : #if DEBUG &amp;&amp; 0
<span class="lineNum">     478 </span>                :            :   fprintf (stderr, &quot;nonlinear nodes: [ %s ]\n&quot;, nlnodes-&gt;toString ());
<span class="lineNum">     479 </span>                :            :   fprintf (stderr, &quot;   linear nodes: [ %s ]\n&quot;, lnnodes-&gt;toString ());
<span class="lineNum">     480 </span>                :            : #endif
<span class="lineNum">     481 </span>                :            : 
<span class="lineNum">     482 </span>                :            :   // organization of the nodes for the MNA:
<span class="lineNum">     483 </span>                :            :   // --------------------------------------
<span class="lineNum">     484 </span>                :            :   // 1.)  balanced nodes: all connected to at least one non-linear device
<span class="lineNum">     485 </span>                :            :   // 2.a) the excitation nodes
<span class="lineNum">     486 </span>                :            :   // 2.b) all linear nodes not contained in 1. and 2.a
<span class="lineNum">     487 </span>                :            :   // 2.c) additional gyrators of linear nodes (built-in voltage sources)
<span class="lineNum">     488 </span>                :            :   // please note: excitation nodes also in 2.b; 1. and 2.a are 'ports'
<span class="lineNum">     489 </span>                :            : 
<span class="lineNum">     490 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   nanodes = new strlist (*nlnodes); // list 1.</span>
<span class="lineNum">     491 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   strlistiterator it;</span>
<span class="lineNum">     492 </span>                :            :   // add excitation nodes; list 2.a
<span class="lineNum">     493 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          2 :   for (it = strlistiterator (exnodes); *it; ++it)</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 6 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>][<span class="branchCov" title="Branch 9 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 12 was taken 1 time"> + </span><span class="branchCov" title="Branch 13 was taken 1 time"> + </span>]
<span class="lineNum">     494 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :     nanodes-&gt;append (*it);</span>
<span class="lineNum">     495 </span>                :            :   // add linear nodes; list 2.b
<span class="lineNum">     496 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          4 :   for (it = strlistiterator (lnnodes); *it; ++it) {</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 6 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>][<span class="branchCov" title="Branch 9 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 12 was taken 3 times"> + </span><span class="branchCov" title="Branch 13 was taken 1 time"> + </span>]
<span class="lineNum">     497 </span>[<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          3 :     if (!nanodes-&gt;contains (*it))</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 1 time"> + </span><span class="branchCov" title="Branch 7 was taken 2 times"> + </span>]
<span class="lineNum">     498 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :       nanodes-&gt;append (*it);</span>
<span class="lineNum">     499 </span>                :            :   }
<span class="lineNum">     500 </span>                :            : 
<span class="lineNum">     501 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   banodes = new strlist (*nlnodes);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">     502 </span>                :            : #if DEBUG &amp;&amp; 0
<span class="lineNum">     503 </span>                :            :   fprintf (stderr, &quot; balanced nodes: [ %s ]\n&quot;, banodes-&gt;toString ());
<span class="lineNum">     504 </span>                :            :   fprintf (stderr, &quot;  exnodes nodes: [ %s ]\n&quot;, exnodes-&gt;toString ());
<span class="lineNum">     505 </span>                :            :   fprintf (stderr, &quot;  nanodes nodes: [ %s ]\n&quot;, nanodes-&gt;toString ());
<span class="lineNum">     506 </span>                :            : #endif
<span class="lineNum">     507 </span>                :<span class="lineCov">          1 : }</span>
<span class="lineNum">     508 </span>                :            : 
<a name="509"><span class="lineNum">     509 </span>                :            : /* The function applies unique voltage source identifiers to each</a>
<span class="lineNum">     510 </span>                :            :    built in internal voltage source in the list of circuits. */
<span class="lineNum">     511 </span>                :<span class="lineCov">          1 : int hbsolver::assignVoltageSources (ptrlist&lt;circuit&gt; circuits) {</span>
<span class="lineNum">     512 </span>                :<span class="lineCov">          1 :   int sources = 0;</span>
<span class="lineNum">     513 </span>        [<span class="branchCov" title="Branch 5 was taken 2 times"> + </span><span class="branchCov" title="Branch 6 was taken 1 time"> + </span>]:<span class="lineCov">          3 :   for (auto *c: circuits) {</span>
<span class="lineNum">     514 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          2 :     if (c-&gt;getVoltageSources () &gt; 0) {</span>
<span class="lineNum">     515 </span>                :<span class="lineCov">          2 :       c-&gt;setVoltageSource (sources);</span>
<span class="lineNum">     516 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :       sources += c-&gt;getVoltageSources ();</span>
<span class="lineNum">     517 </span>                :            :     }
<span class="lineNum">     518 </span>                :            :   }
<span class="lineNum">     519 </span>                :<span class="lineCov">          1 :   return sources;</span>
<span class="lineNum">     520 </span>                :            : }
<a name="521"><span class="lineNum">     521 </span>                :            : </a>
<span class="lineNum">     522 </span>                :            : /* The function assigns unique node identifiers to each circuit node. */
<span class="lineNum">     523 </span>                :<span class="lineCov">          3 : int hbsolver::assignNodes (ptrlist&lt;circuit&gt; circuits, strlist * nodes,</span>
<span class="lineNum">     524 </span>                :            :                            int offset) {
<span class="lineNum">     525 </span>                :            :   // through all collected nodes
<span class="lineNum">     526 </span>        [<span class="branchCov" title="Branch 1 was taken 9 times"> + </span><span class="branchCov" title="Branch 2 was taken 3 times"> + </span>]:<span class="lineCov">         12 :   for (int nr = 0; nr &lt; nodes-&gt;length (); nr++) {</span>
<span class="lineNum">     527 </span>                :<span class="lineCov">          9 :     char * nn = nodes-&gt;get (nr);</span>
<span class="lineNum">     528 </span>                :            :     // through all circuits
<span class="lineNum">     529 </span>        [<span class="branchCov" title="Branch 5 was taken 12 times"> + </span><span class="branchCov" title="Branch 6 was taken 9 times"> + </span>]:<span class="lineCov">         21 :     for (auto *c : circuits) {</span>
<span class="lineNum">     530 </span>                :            :       // assign current identifier if any of the circuit nodes equals
<span class="lineNum">     531 </span>                :            :       // the current one
<span class="lineNum">     532 </span>        [<span class="branchCov" title="Branch 1 was taken 24 times"> + </span><span class="branchCov" title="Branch 2 was taken 12 times"> + </span>]:<span class="lineCov">         36 :       for (int i = 0; i &lt; c-&gt;getSize (); i++) {</span>
<span class="lineNum">     533 </span>        [<span class="branchCov" title="Branch 0 was taken 24 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         24 :         node * n = c-&gt;getNode (i);</span>
<span class="lineNum">     534 </span>        [<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchCov" title="Branch 2 was taken 18 times"> + </span>]:<span class="lineCov">         24 :         if (!strcmp (n-&gt;getName (), nn)) n-&gt;setNode (offset + nr + 1);</span>
<span class="lineNum">     535 </span>                :            :       }
<span class="lineNum">     536 </span>                :            :     }
<span class="lineNum">     537 </span>                :            :   }
<span class="lineNum">     538 </span>                :<span class="lineCov">          3 :   return nodes-&gt;length ();</span>
<span class="lineNum">     539 </span>                :            : }
<a name="540"><span class="lineNum">     540 </span>                :            : </a>
<span class="lineNum">     541 </span>                :            : // Prepares the linear operations.
<span class="lineNum">     542 </span>                :<span class="lineCov">          1 : void hbsolver::prepareLinear (void) {</span>
<span class="lineNum">     543 </span>        [<span class="branchCov" title="Branch 5 was taken 2 times"> + </span><span class="branchCov" title="Branch 6 was taken 1 time"> + </span>]:<span class="lineCov">          3 :   for (auto *lc : lincircuits)</span>
<span class="lineNum">     544 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :     lc-&gt;initHB ();</span>
<span class="lineNum">     545 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   nlnvsrcs = assignVoltageSources (lincircuits);</span>
<span class="lineNum">     546 </span>                :<span class="lineCov">          1 :   nnlvsrcs = excitations.size ();</span>
<span class="lineNum">     547 </span>                :<span class="lineCov">          1 :   nnanodes = nanodes-&gt;length ();</span>
<span class="lineNum">     548 </span>                :<span class="lineCov">          1 :   nexnodes = exnodes-&gt;length ();</span>
<span class="lineNum">     549 </span>                :<span class="lineCov">          1 :   nbanodes = banodes-&gt;length ();</span>
<span class="lineNum">     550 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   assignNodes (lincircuits, nanodes);</span>
<span class="lineNum">     551 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   assignNodes (excitations, nanodes);</span>
<span class="lineNum">     552 </span>                :<span class="lineCov">          1 :   createMatrixLinearA ();</span>
<span class="lineNum">     553 </span>                :<span class="lineCov">          1 :   createMatrixLinearY ();</span>
<span class="lineNum">     554 </span>                :<span class="lineCov">          1 :   calcConstantCurrent ();</span>
<span class="lineNum">     555 </span>                :<span class="lineCov">          1 : }</span>
<span class="lineNum">     556 </span>                :            : 
<span class="lineNum">     557 </span>                :            : /* The function creates the complex linear network MNA matrix.  It
<a name="558"><span class="lineNum">     558 </span>                :            :    contains the MNA entries for all linear components for each</a>
<span class="lineNum">     559 </span>                :            :    requested frequency. */
<span class="lineNum">     560 </span>                :<span class="lineCov">          1 : void hbsolver::createMatrixLinearA (void) {</span>
<span class="lineNum">     561 </span>                :<span class="lineCov">          1 :   int M = nlnvsrcs;</span>
<span class="lineNum">     562 </span>                :<span class="lineCov">          1 :   int N = nnanodes;</span>
<span class="lineNum">     563 </span>                :<span class="lineCov">          1 :   int f = 0;</span>
<span class="lineNum">     564 </span>                :            :   nr_double_t freq;
<span class="lineNum">     565 </span>                :            : 
<span class="lineNum">     566 </span>                :            :   // create new MNA matrix
<span class="lineNum">     567 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   A = new tmatrix&lt;nr_complex_t&gt; ((N + M) * lnfreqs);</span>
<span class="lineNum">     568 </span>                :            : 
<span class="lineNum">     569 </span>                :            :   // through each frequency
<span class="lineNum">     570 </span>        [<span class="branchCov" title="Branch 1 was taken 9 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">         10 :   for (int i = 0; i &lt; rfreqs.getSize (); i++) {</span>
<span class="lineNum">     571 </span>                :<span class="lineCov">          9 :     freq = rfreqs (i);</span>
<span class="lineNum">     572 </span>                :            :     // calculate components' MNA matrix for the given frequency
<span class="lineNum">     573 </span>        [<span class="branchCov" title="Branch 5 was taken 18 times"> + </span><span class="branchCov" title="Branch 6 was taken 9 times"> + </span>]:<span class="lineCov">         27 :     for (auto *lc : lincircuits)</span>
<span class="lineNum">     574 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         18 :       lc-&gt;calcHB (freq);</span>
<span class="lineNum">     575 </span>                :            :     // fill in all matrix entries for the given frequency
<span class="lineNum">     576 </span>                :<span class="lineCov">          9 :     fillMatrixLinearA (A, f++);</span>
<span class="lineNum">     577 </span>                :            :   }
<span class="lineNum">     578 </span>                :            : 
<span class="lineNum">     579 </span>                :            :   // save a copy of the original MNA matrix
<span class="lineNum">     580 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   NA = new tmatrix&lt;nr_complex_t&gt; (*A);</span>
<span class="lineNum">     581 </span>                :<span class="lineCov">          1 : }</span>
<span class="lineNum">     582 </span>                :            : 
<span class="lineNum">     583 </span>                :            : // some definitions for the linear matrix filler
<span class="lineNum">     584 </span>                :            : #undef  A_
<span class="lineNum">     585 </span>                :            : #undef  B_
<span class="lineNum">     586 </span>                :            : #define A_(r,c) (*A) ((r)*lnfreqs+f,(c)*lnfreqs+f)
<span class="lineNum">     587 </span>                :            : #define G_(r,c) A_(r,c)
<span class="lineNum">     588 </span>                :            : #define B_(r,c) A_(r,c+N)
<span class="lineNum">     589 </span>                :            : #define C_(r,c) A_(r+N,c)
<span class="lineNum">     590 </span>                :            : #define D_(r,c) A_(r+N,c+N)
<span class="lineNum">     591 </span>                :            : 
<a name="592"><span class="lineNum">     592 </span>                :            : /* This function fills in the MNA matrix entries into the A matrix for</a>
<span class="lineNum">     593 </span>                :            :    a given frequency index. */
<span class="lineNum">     594 </span>                :<span class="lineCov">          9 : void hbsolver::fillMatrixLinearA (tmatrix&lt;nr_complex_t&gt; * A, int f) {</span>
<span class="lineNum">     595 </span>                :<span class="lineCov">          9 :   int N = nnanodes;</span>
<span class="lineNum">     596 </span>                :            : 
<span class="lineNum">     597 </span>                :            :   // through each linear circuit
<span class="lineNum">     598 </span>        [<span class="branchCov" title="Branch 5 was taken 18 times"> + </span><span class="branchCov" title="Branch 6 was taken 9 times"> + </span>]:<span class="lineCov">         27 :   for (auto *cir : lincircuits) {</span>
<span class="lineNum">     599 </span>                :<span class="lineCov">         18 :     int s = cir-&gt;getSize ();</span>
<span class="lineNum">     600 </span>                :            :     int nr, nc, r, c, v;
<span class="lineNum">     601 </span>                :            : 
<span class="lineNum">     602 </span>                :            :     // apply G-matrix entries
<span class="lineNum">     603 </span>        [<span class="branchCov" title="Branch 0 was taken 36 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         54 :     for (r = 0; r &lt; s; r++) {</span>
<span class="lineNum">     604 </span>[<span class="branchCov" title="Branch 0 was taken 36 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 36 times"> + </span>]:<span class="lineCov">         36 :       if ((nr = cir-&gt;getNode(r)-&gt;getNode () - 1) &lt; 0) continue;</span>
<span class="lineNum">     605 </span>        [<span class="branchCov" title="Branch 0 was taken 72 times"> + </span><span class="branchCov" title="Branch 1 was taken 36 times"> + </span>]:<span class="lineCov">        108 :       for (c = 0; c &lt; s; c++) {</span>
<span class="lineNum">     606 </span>[<span class="branchCov" title="Branch 0 was taken 72 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 72 times"> + </span>]:<span class="lineCov">         72 :         if ((nc = cir-&gt;getNode(c)-&gt;getNode () - 1) &lt; 0) continue;</span>
<span class="lineNum">     607 </span>[<span class="branchCov" title="Branch 0 was taken 72 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 72 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         72 :         G_(nr, nc) += cir-&gt;getY (r, c);</span>
<span class="lineNum">     608 </span>                :            :       }
<span class="lineNum">     609 </span>                :            :     }
<span class="lineNum">     610 </span>                :            : 
<span class="lineNum">     611 </span>                :            :     // augmented part -- built in voltage sources
<span class="lineNum">     612 </span>[<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         18 :     if ((v = cir-&gt;getVoltageSources ()) &gt; 0) {</span>
<span class="lineNum">     613 </span>                :            : 
<span class="lineNum">     614 </span>                :            :       // apply B-matrix entries
<span class="lineNum">     615 </span>        [<span class="branchCov" title="Branch 0 was taken 36 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         54 :       for (r = 0; r &lt; s; r++) {</span>
<span class="lineNum">     616 </span>[<span class="branchCov" title="Branch 0 was taken 36 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 36 times"> + </span>]:<span class="lineCov">         36 :         if ((nr = cir-&gt;getNode(r)-&gt;getNode () - 1) &lt; 0) continue;</span>
<span class="lineNum">     617 </span>        [<span class="branchCov" title="Branch 0 was taken 36 times"> + </span><span class="branchCov" title="Branch 1 was taken 36 times"> + </span>]:<span class="lineCov">         72 :         for (c = 0; c &lt; v; c++) {</span>
<span class="lineNum">     618 </span>                :<span class="lineCov">         36 :           nc = cir-&gt;getVoltageSource () + c;</span>
<span class="lineNum">     619 </span>[<span class="branchCov" title="Branch 0 was taken 36 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 36 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         36 :           B_(nr, nc) += cir-&gt;getB (r, nc);</span>
<span class="lineNum">     620 </span>                :            :         }
<span class="lineNum">     621 </span>                :            :       }
<span class="lineNum">     622 </span>                :            : 
<span class="lineNum">     623 </span>                :            :       // apply C-matrix entries
<span class="lineNum">     624 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         36 :       for (r = 0; r &lt; v; r++) {</span>
<span class="lineNum">     625 </span>                :<span class="lineCov">         18 :         nr = cir-&gt;getVoltageSource () + r;</span>
<span class="lineNum">     626 </span>        [<span class="branchCov" title="Branch 0 was taken 36 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         54 :         for (c = 0; c &lt; s; c++) {</span>
<span class="lineNum">     627 </span>[<span class="branchCov" title="Branch 0 was taken 36 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 36 times"> + </span>]:<span class="lineCov">         36 :           if ((nc = cir-&gt;getNode(c)-&gt;getNode () - 1) &lt; 0) continue;</span>
<span class="lineNum">     628 </span>[<span class="branchCov" title="Branch 0 was taken 36 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 36 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         36 :           C_(nr, nc) += cir-&gt;getC (nr, c);</span>
<span class="lineNum">     629 </span>                :            :         }
<span class="lineNum">     630 </span>                :            :       }
<span class="lineNum">     631 </span>                :            : 
<span class="lineNum">     632 </span>                :            :       // apply D-matrix entries
<span class="lineNum">     633 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         36 :       for (r = 0; r &lt; v; r++) {</span>
<span class="lineNum">     634 </span>                :<span class="lineCov">         18 :         nr = cir-&gt;getVoltageSource () + r;</span>
<span class="lineNum">     635 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         36 :         for (c = 0; c &lt; v; c++) {</span>
<span class="lineNum">     636 </span>                :<span class="lineCov">         18 :           nc = cir-&gt;getVoltageSource () + c;</span>
<span class="lineNum">     637 </span>[<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         18 :           D_(nr, nc) += cir-&gt;getD (nr, nc);</span>
<span class="lineNum">     638 </span>                :            :         }
<span class="lineNum">     639 </span>                :            :       }
<span class="lineNum">     640 </span>                :            :     }
<span class="lineNum">     641 </span>                :            :   }
<span class="lineNum">     642 </span>                :<span class="lineCov">          9 : }</span>
<a name="643"><span class="lineNum">     643 </span>                :            : </a>
<span class="lineNum">     644 </span>                :            : // The function inverts the given matrix A into the matrix H.
<span class="lineNum">     645 </span>                :<span class="lineCov">          1 : void hbsolver::invertMatrix (tmatrix&lt;nr_complex_t&gt; * A,</span>
<span class="lineNum">     646 </span>                :            :                              tmatrix&lt;nr_complex_t&gt; * H) {
<span class="lineNum">     647 </span>                :<span class="lineCov">          1 :   eqnsys&lt;nr_complex_t&gt; eqns;</span>
<span class="lineNum">     648 </span>                :<span class="lineCov">          1 :   int N = A-&gt;getCols ();</span>
<span class="lineNum">     649 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   tvector&lt;nr_complex_t&gt; * x = new tvector&lt;nr_complex_t&gt; (N);</span>
<span class="lineNum">     650 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   tvector&lt;nr_complex_t&gt; * z = new tvector&lt;nr_complex_t&gt; (N);</span>
<span class="lineNum">     651 </span>                :            : 
<span class="lineNum">     652 </span>                :            :   try_running () {
<span class="lineNum">     653 </span>                :            :     // create LU decomposition of the A matrix
<span class="lineNum">     654 </span>                :<span class="lineCov">          1 :     eqns.setAlgo (ALGO_LU_FACTORIZATION_CROUT);</span>
<span class="lineNum">     655 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     eqns.passEquationSys (A, x, z);</span>
<span class="lineNum">     656 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     eqns.solve ();</span>
<span class="lineNum">     657 </span>                :            :   }
<span class="lineNum">     658 </span>                :            :   // appropriate exception handling
<span class="lineNum">     659 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 1 time"> + </span>]:<span class="lineCov">          1 :   catch_exception () {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">     660 </span>                :            :   case EXCEPTION_PIVOT:
<span class="lineNum">     661 </span>                :            :   default:
<span class="lineNum">     662 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     logprint (LOG_ERROR, &quot;WARNING: %s: during TI inversion\n&quot;, getName ());</span>
<span class="lineNum">     663 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     estack.print ();</span>
<span class="lineNum">     664 </span>                :            :   }
<span class="lineNum">     665 </span>                :            : 
<span class="lineNum">     666 </span>                :            :   // use the LU decomposition to obtain the inverse H
<span class="lineNum">     667 </span>                :<span class="lineCov">          1 :   eqns.setAlgo (ALGO_LU_SUBSTITUTION_CROUT);</span>
<span class="lineNum">     668 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         19 :   for (int c = 0; c &lt; N; c++) {</span>
<span class="lineNum">     669 </span>                :<span class="lineCov">         18 :     z-&gt;set (0.0);</span>
<span class="lineNum">     670 </span>        [<span class="branchCov" title="Branch 1 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         18 :     z-&gt;set (c, 1.0);</span>
<span class="lineNum">     671 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         18 :     eqns.passEquationSys (A, x, z);</span>
<span class="lineNum">     672 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         18 :     eqns.solve ();</span>
<span class="lineNum">     673 </span>[<span class="branchCov" title="Branch 0 was taken 324 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 324 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        342 :     for (int r = 0; r &lt; N; r++) H-&gt;set (r, c, x-&gt;get (r));</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 324 times"> + </span><span class="branchCov" title="Branch 7 was taken 18 times"> + </span>]
<span class="lineNum">     674 </span>                :            :   }
<span class="lineNum">     675 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   delete x;</span>
<span class="lineNum">     676 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   delete z;</span>
<span class="lineNum">     677 </span>                :<span class="lineCov">          1 : }</span>
<span class="lineNum">     678 </span>                :            : 
<span class="lineNum">     679 </span>                :            : // Some defines for matrix element access.
<span class="lineNum">     680 </span>                :            : #define V_(r) (*V) (r)
<span class="lineNum">     681 </span>                :            : #define I_(r) (*I) (r)
<span class="lineNum">     682 </span>                :            : #undef  A_
<span class="lineNum">     683 </span>                :            : #define A_(r,c) (*A) (r,c)
<span class="lineNum">     684 </span>                :            : 
<span class="lineNum">     685 </span>                :            : #define Z_(r,c) (*Z) (r,c)
<span class="lineNum">     686 </span>                :            : #define Y_(r,c) (*Y) (r,c)
<span class="lineNum">     687 </span>                :            : 
<span class="lineNum">     688 </span>                :            : #define ZVU_(r,c) Z_(r,c)
<span class="lineNum">     689 </span>                :            : #define ZVL_(r,c) Z_((r)*lnfreqs+f+sn,c)
<span class="lineNum">     690 </span>                :            : #define ZCU_(r,c) Z_(r,(c)*lnfreqs+f+sn)
<span class="lineNum">     691 </span>                :            : #define ZCL_(r,c) Z_((r)*lnfreqs+f+sn,(c)*lnfreqs+f+sn)
<span class="lineNum">     692 </span>                :            : 
<span class="lineNum">     693 </span>                :            : #define YV_(r,c) (*YV) (r,c)
<span class="lineNum">     694 </span>                :            : #define NA_(r,c) (*NA) (r,c)
<span class="lineNum">     695 </span>                :            : #define JF_(r,c) (*JF) (r,c)
<span class="lineNum">     696 </span>                :            : 
<span class="lineNum">     697 </span>                :            : /* The following function performs the following steps:
<span class="lineNum">     698 </span>                :            :    1. form the MNA matrix A including all nodes (linear, non-linear and
<span class="lineNum">     699 </span>                :            :       excitations)
<span class="lineNum">     700 </span>                :            :    2. compute the variable transimpedance matrix entries for the nodes
<span class="lineNum">     701 </span>                :            :       to be balanced
<span class="lineNum">     702 </span>                :            :    3. compute the constant transimpedance matrix entries for the constant
<span class="lineNum">     703 </span>                :            :       current vector caused by the excitations
<span class="lineNum">     704 </span>                :            :    4. invert this overall transimpedance matrix
<a name="705"><span class="lineNum">     705 </span>                :            :    5. extract the variable transadmittance matrix entries</a>
<span class="lineNum">     706 </span>                :            : */
<span class="lineNum">     707 </span>                :<span class="lineCov">          1 : void hbsolver::createMatrixLinearY (void) {</span>
<span class="lineNum">     708 </span>                :<span class="lineCov">          1 :   int M = nlnvsrcs;</span>
<span class="lineNum">     709 </span>                :<span class="lineCov">          1 :   int N = nnanodes;</span>
<span class="lineNum">     710 </span>                :            :   int c, r, f;
<span class="lineNum">     711 </span>                :            : 
<span class="lineNum">     712 </span>                :            :   // size of overall MNA matrix
<span class="lineNum">     713 </span>                :<span class="lineCov">          1 :   int sa = (N + M) * lnfreqs;</span>
<span class="lineNum">     714 </span>                :<span class="lineCov">          1 :   int sv = nbanodes;</span>
<span class="lineNum">     715 </span>                :<span class="lineCov">          1 :   int se = nnlvsrcs;</span>
<span class="lineNum">     716 </span>                :<span class="lineCov">          1 :   int sy = sv + se;</span>
<span class="lineNum">     717 </span>                :            : 
<span class="lineNum">     718 </span>                :            :   // allocate new transimpedance matrix
<span class="lineNum">     719 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   Z = new tmatrix&lt;nr_complex_t&gt; (sy * lnfreqs);</span>
<span class="lineNum">     720 </span>                :            : 
<span class="lineNum">     721 </span>                :            :   // prepare equation system
<span class="lineNum">     722 </span>                :<span class="lineCov">          1 :   eqnsys&lt;nr_complex_t&gt; eqns;</span>
<span class="lineNum">     723 </span>                :            :   tvector&lt;nr_complex_t&gt; * V;
<span class="lineNum">     724 </span>                :            :   tvector&lt;nr_complex_t&gt; * I;
<span class="lineNum">     725 </span>                :            : 
<span class="lineNum">     726 </span>                :            :   // 1. create variable transimpedance matrix entries relating
<span class="lineNum">     727 </span>                :            :   // voltages at the balanced nodes to the currents through these
<span class="lineNum">     728 </span>                :            :   // nodes into the non-linear part
<span class="lineNum">     729 </span>                :<span class="lineCov">          1 :   int sn = sv * lnfreqs;</span>
<span class="lineNum">     730 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   V = new tvector&lt;nr_complex_t&gt; (sa);</span>
<span class="lineNum">     731 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   I = new tvector&lt;nr_complex_t&gt; (sa);</span>
<span class="lineNum">     732 </span>                :            : 
<span class="lineNum">     733 </span>                :            :   // connect a 100 Ohm resistor (to ground) to balanced node in the MNA matrix
<span class="lineNum">     734 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 9 times"> + </span><span class="branchCov" title="Branch 5 was taken 1 time"> + </span>]:<span class="lineCov">         10 :   for (c = 0; c &lt; sv * lnfreqs; c++) A_(c, c) += 0.01;</span>
<span class="lineNum">     735 </span>                :            : 
<span class="lineNum">     736 </span>                :            :   // connect a 100 Ohm resistor (in parallel) to each excitation
<span class="lineNum">     737 </span>        [<span class="branchCov" title="Branch 5 was taken 1 time"> + </span><span class="branchCov" title="Branch 6 was taken 1 time"> + </span>]:<span class="lineCov">          2 :   for (auto *vs : excitations) {</span>
<span class="lineNum">     738 </span>                :            :     // get positive and negative node
<span class="lineNum">     739 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     int pnode = vs-&gt;getNode(NODE_1)-&gt;getNode ();</span>
<span class="lineNum">     740 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     int nnode = vs-&gt;getNode(NODE_2)-&gt;getNode ();</span>
<span class="lineNum">     741 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         10 :     for (f = 0; f &lt; lnfreqs; f++) { // for each frequency</span>
<span class="lineNum">     742 </span>                :<span class="lineCov">          9 :       int pn = (pnode - 1) * lnfreqs + f;</span>
<span class="lineNum">     743 </span>                :<span class="lineCov">          9 :       int nn = (nnode - 1) * lnfreqs + f;</span>
<span class="lineNum">     744 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          9 :       if (pnode) A_(pn, pn) += 0.01;</span>
<span class="lineNum">     745 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          9 :       if (nnode) A_(nn, nn) += 0.01;</span>
<span class="lineNum">     746 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 9 times"> + </span>]:<span class="lineCov">          9 :       if (pnode &amp;&amp; nnode) {</span>
<span class="lineNum">     747 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         A_(pn, nn) -= 0.01;</span>
<span class="lineNum">     748 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         A_(nn, pn) -= 0.01;</span>
<span class="lineNum">     749 </span>                :            :       }
<span class="lineNum">     750 </span>                :            :     }
<span class="lineNum">     751 </span>                :            :   }
<span class="lineNum">     752 </span>                :            : 
<span class="lineNum">     753 </span>                :            :   // LU decompose the MNA matrix
<span class="lineNum">     754 </span>                :            :   try_running () {
<span class="lineNum">     755 </span>                :<span class="lineCov">          1 :     eqns.setAlgo (ALGO_LU_FACTORIZATION_CROUT);</span>
<span class="lineNum">     756 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     eqns.passEquationSys (A, V, I);</span>
<span class="lineNum">     757 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     eqns.solve ();</span>
<span class="lineNum">     758 </span>                :            :   }
<span class="lineNum">     759 </span>                :            :   // appropriate exception handling
<span class="lineNum">     760 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 1 time"> + </span>]:<span class="lineCov">          1 :   catch_exception () {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">     761 </span>                :            :   case EXCEPTION_PIVOT:
<span class="lineNum">     762 </span>                :            :   default:
<span class="lineNum">     763 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     logprint (LOG_ERROR, &quot;WARNING: %s: during A factorization\n&quot;, getName ());</span>
<span class="lineNum">     764 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     estack.print ();</span>
<span class="lineNum">     765 </span>                :            :   }
<span class="lineNum">     766 </span>                :            : 
<span class="lineNum">     767 </span>                :            :   // aquire variable transimpedance matrix entries
<span class="lineNum">     768 </span>                :<span class="lineCov">          1 :   eqns.setAlgo (ALGO_LU_SUBSTITUTION_CROUT);</span>
<span class="lineNum">     769 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         10 :   for (c = 0; c &lt; sn; c++) {</span>
<span class="lineNum">     770 </span>                :<span class="lineCov">          9 :     I-&gt;set (0.0);</span>
<span class="lineNum">     771 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :     I_(c) = 1.0;</span>
<span class="lineNum">     772 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :     eqns.passEquationSys (A, V, I);</span>
<span class="lineNum">     773 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :     eqns.solve ();</span>
<span class="lineNum">     774 </span>                :            :     // ZV | ..
<span class="lineNum">     775 </span>                :            :     // ---+---
<span class="lineNum">     776 </span>                :            :     // .. | ..
<span class="lineNum">     777 </span>[<span class="branchCov" title="Branch 0 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         90 :     for (r = 0; r &lt; sn; r++) ZVU_(r, c) = V_(r);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 81 times"> + </span><span class="branchCov" title="Branch 7 was taken 9 times"> + </span>]
<span class="lineNum">     778 </span>                :            :     // .. | ..
<span class="lineNum">     779 </span>                :            :     // ---+---
<span class="lineNum">     780 </span>                :            :     // ZV | ..
<span class="lineNum">     781 </span>                :<span class="lineCov">          9 :     r = 0;</span>
<span class="lineNum">     782 </span>        [<span class="branchCov" title="Branch 5 was taken 9 times"> + </span><span class="branchCov" title="Branch 6 was taken 9 times"> + </span>]:<span class="lineCov">         18 :     for (auto *e : excitations) {</span>
<span class="lineNum">     783 </span>                :            :       // lower part entries
<span class="lineNum">     784 </span>        [<span class="branchCov" title="Branch 0 was taken 81 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">         90 :       for (f = 0; f &lt; lnfreqs; f++) {</span>
<span class="lineNum">     785 </span>[<span class="branchCov" title="Branch 0 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         81 :         ZVL_(r, c) = excitationZ (V, e, f);</span>
<span class="lineNum">     786 </span>                :            :       }
<span class="lineNum">     787 </span>                :            :     }
<span class="lineNum">     788 </span>                :            :   }
<span class="lineNum">     789 </span>                :            : 
<span class="lineNum">     790 </span>                :            :   // create constant transimpedance matrix entries relating the
<span class="lineNum">     791 </span>                :            :   // source voltages to the interconnection currents
<span class="lineNum">     792 </span>                :<span class="lineCov">          1 :   int vsrc = 0;</span>
<span class="lineNum">     793 </span>                :            :   // aquire constant transadmittance matrix entries
<span class="lineNum">     794 </span>        [<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchCov" title="Branch 5 was taken 1 time"> + </span>]:<span class="lineCov">          2 :   for (auto it = excitations.begin(); it != excitations.end(); ++it, vsrc++) {</span>
<span class="lineNum">     795 </span>                :<span class="lineCov">          1 :     circuit * vs = *it;</span>
<span class="lineNum">     796 </span>                :            :     // get positive and negative node
<span class="lineNum">     797 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     int pnode = vs-&gt;getNode(NODE_1)-&gt;getNode ();</span>
<span class="lineNum">     798 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     int nnode = vs-&gt;getNode(NODE_2)-&gt;getNode ();</span>
<span class="lineNum">     799 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         10 :     for (f = 0; f &lt; lnfreqs; f++) { // for each frequency</span>
<span class="lineNum">     800 </span>                :<span class="lineCov">          9 :       int pn = (pnode - 1) * lnfreqs + f;</span>
<span class="lineNum">     801 </span>                :<span class="lineCov">          9 :       int nn = (nnode - 1) * lnfreqs + f;</span>
<span class="lineNum">     802 </span>                :<span class="lineCov">          9 :       I-&gt;set (0.0);</span>
<span class="lineNum">     803 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          9 :       if (pnode) I_(pn) = +1.0;</span>
<span class="lineNum">     804 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          9 :       if (nnode) I_(nn) = -1.0;</span>
<span class="lineNum">     805 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :       eqns.passEquationSys (A, V, I);</span>
<span class="lineNum">     806 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :       eqns.solve ();</span>
<span class="lineNum">     807 </span>                :            :       // .. | ZC
<span class="lineNum">     808 </span>                :            :       // ---+---
<span class="lineNum">     809 </span>                :            :       // .. | ..
<span class="lineNum">     810 </span>        [<span class="branchCov" title="Branch 0 was taken 81 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">         90 :       for (r = 0; r &lt; sn; r++) {</span>
<span class="lineNum">     811 </span>                :            :         // upper part of the entries
<span class="lineNum">     812 </span>[<span class="branchCov" title="Branch 0 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         81 :         ZCU_(r, vsrc) = V_(r);</span>
<span class="lineNum">     813 </span>                :            :       }
<span class="lineNum">     814 </span>                :            :       // .. | ..
<span class="lineNum">     815 </span>                :            :       // ---+---
<span class="lineNum">     816 </span>                :            :       // .. | ZC
<span class="lineNum">     817 </span>                :<span class="lineCov">          9 :       r = 0;</span>
<span class="lineNum">     818 </span>        [<span class="branchCov" title="Branch 4 was taken 9 times"> + </span><span class="branchCov" title="Branch 5 was taken 9 times"> + </span>]:<span class="lineCov">         18 :       for (auto ite = excitations.begin(); ite != excitations.end(); ++ite, r++) {</span>
<span class="lineNum">     819 </span>                :            :         // lower part entries
<span class="lineNum">     820 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          9 :         ZCL_(r, vsrc) = excitationZ (V, *ite, f);</span>
<span class="lineNum">     821 </span>                :            :       }
<span class="lineNum">     822 </span>                :            :     }
<span class="lineNum">     823 </span>                :            :   }
<span class="lineNum">     824 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   delete I;</span>
<span class="lineNum">     825 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   delete V;</span>
<span class="lineNum">     826 </span>                :            : 
<span class="lineNum">     827 </span>                :            :   // allocate new transadmittance matrix
<span class="lineNum">     828 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   Y = new tmatrix&lt;nr_complex_t&gt; (sy * lnfreqs);</span>
<span class="lineNum">     829 </span>                :            : 
<span class="lineNum">     830 </span>                :            :   // invert the Z matrix to a Y matrix
<span class="lineNum">     831 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   invertMatrix (Z, Y);</span>
<span class="lineNum">     832 </span>                :            : 
<span class="lineNum">     833 </span>                :            :   // substract the 100 Ohm resistor
<span class="lineNum">     834 </span>[<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 18 times"> + </span><span class="branchCov" title="Branch 5 was taken 1 time"> + </span>]:<span class="lineCov">         19 :   for (c = 0; c &lt; sy * lnfreqs; c++) Y_(c, c) -= 0.01;</span>
<span class="lineNum">     835 </span>                :            : 
<span class="lineNum">     836 </span>                :            :   // extract the variable transadmittance matrix
<span class="lineNum">     837 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   YV = new tmatrix&lt;nr_complex_t&gt; (sv * nlfreqs);</span>
<span class="lineNum">     838 </span>                :            : 
<span class="lineNum">     839 </span>                :            :   // variable transadmittance matrix must be continued conjugately
<span class="lineNum">     840 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   *YV = expandMatrix (*Y, sv);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">     841 </span>                :            : 
<span class="lineNum">     842 </span>                :            :   // delete overall temporary MNA matrix
<span class="lineNum">     843 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   delete A; A = NULL;</span>
<span class="lineNum">     844 </span>                :            :   // delete transimpedance matrix
<span class="lineNum">     845 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   delete Z; Z = NULL;</span>
<span class="lineNum">     846 </span>                :<span class="lineCov">          1 : }</span>
<span class="lineNum">     847 </span>                :            : 
<span class="lineNum">     848 </span>                :            : /* Little helper function obtaining a transimpedance value for the
<a name="849"><span class="lineNum">     849 </span>                :            :    given voltage source (excitation) and for a given frequency</a>
<span class="lineNum">     850 </span>                :            :    index. */
<span class="lineNum">     851 </span>                :<span class="lineCov">         90 : nr_complex_t hbsolver::excitationZ (tvector&lt;nr_complex_t&gt; * V, circuit * vs,</span>
<span class="lineNum">     852 </span>                :            :                                     int f) {
<span class="lineNum">     853 </span>                :            :   // get positive and negative node
<span class="lineNum">     854 </span>        [<span class="branchCov" title="Branch 0 was taken 90 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         90 :   int pnode = vs-&gt;getNode(NODE_1)-&gt;getNode ();</span>
<span class="lineNum">     855 </span>        [<span class="branchCov" title="Branch 0 was taken 90 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         90 :   int nnode = vs-&gt;getNode(NODE_2)-&gt;getNode ();</span>
<span class="lineNum">     856 </span>                :<span class="lineCov">         90 :   nr_complex_t z = 0.0;</span>
<span class="lineNum">     857 </span>[<span class="branchCov" title="Branch 0 was taken 90 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 90 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         90 :   if (pnode) z += V_((pnode - 1) * lnfreqs + f);</span>
<span class="lineNum">     858 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 90 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">         90 :   if (nnode) z -= V_((nnode - 1) * lnfreqs + f);</span>
<span class="lineNum">     859 </span>                :<span class="lineCov">         90 :   return z;</span>
<span class="lineNum">     860 </span>                :            : }
<span class="lineNum">     861 </span>                :            : 
<span class="lineNum">     862 </span>                :            : /* This function computes the constant current vectors using the
<a name="863"><span class="lineNum">     863 </span>                :            :    voltage of the excitations and the transadmittance matrix</a>
<span class="lineNum">     864 </span>                :            :    entries. */
<span class="lineNum">     865 </span>                :<span class="lineCov">          1 : void hbsolver::calcConstantCurrent (void) {</span>
<span class="lineNum">     866 </span>                :<span class="lineCov">          1 :   int se = nnlvsrcs * lnfreqs;</span>
<span class="lineNum">     867 </span>                :<span class="lineCov">          1 :   int sn = nbanodes * lnfreqs;</span>
<span class="lineNum">     868 </span>                :<span class="lineCov">          1 :   int r, c, vsrc = 0;</span>
<span class="lineNum">     869 </span>                :            : 
<span class="lineNum">     870 </span>                :            :   // collect excitation voltages
<span class="lineNum">     871 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   tvector&lt;nr_complex_t&gt; VC (se);</span>
<span class="lineNum">     872 </span>        [<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchCov" title="Branch 5 was taken 1 time"> + </span>]:<span class="lineCov">          2 :   for (auto it = excitations.begin(); it != excitations.end(); ++it, vsrc++) {</span>
<span class="lineNum">     873 </span>                :<span class="lineCov">          1 :     circuit * vs = *it;</span>
<span class="lineNum">     874 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     vs-&gt;initHB ();</span>
<span class="lineNum">     875 </span>                :<span class="lineCov">          1 :     vs-&gt;setVoltageSource (0);</span>
<span class="lineNum">     876 </span>        [<span class="branchCov" title="Branch 1 was taken 9 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">         10 :     for (int f = 0; f &lt; rfreqs.getSize (); f++) { // for each frequency</span>
<span class="lineNum">     877 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :       nr_double_t freq = rfreqs (f);</span>
<span class="lineNum">     878 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :       vs-&gt;calcHB (freq);</span>
<span class="lineNum">     879 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          9 :       VC (vsrc * lnfreqs + f) = vs-&gt;getE (VSRC_1);</span>
<span class="lineNum">     880 </span>                :            :     }
<span class="lineNum">     881 </span>                :            :   }
<span class="lineNum">     882 </span>                :            : 
<span class="lineNum">     883 </span>                :            :   // compute constant current vector for balanced nodes
<span class="lineNum">     884 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   IC = new tvector&lt;nr_complex_t&gt; (sn);</span>
<span class="lineNum">     885 </span>                :            :   // .. | YC * VC
<span class="lineNum">     886 </span>                :            :   // ---+---
<span class="lineNum">     887 </span>                :            :   // .. | ..
<span class="lineNum">     888 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         10 :   for (r = 0; r &lt; sn; r++) {</span>
<span class="lineNum">     889 </span>                :<span class="lineCov">          9 :     nr_complex_t i = 0.0;</span>
<span class="lineNum">     890 </span>        [<span class="branchCov" title="Branch 0 was taken 81 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">         90 :     for (c = 0; c &lt; se; c++) {</span>
<span class="lineNum">     891 </span>[<span class="branchCov" title="Branch 0 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         81 :       i += Y_(r, c + sn) * VC (c);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">     892 </span>                :            :     }
<span class="lineNum">     893 </span>                :<span class="lineCov">          9 :     int f = r % lnfreqs;</span>
<span class="lineNum">     894 </span>[<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>][<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>]:<span class="lineCov">          9 :     if (f != 0 &amp;&amp; f != lnfreqs - 1) i /= 2;</span>
<span class="lineNum">     895 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :     IC-&gt;set (r, i);</span>
<span class="lineNum">     896 </span>                :            :   }
<span class="lineNum">     897 </span>                :            :   // expand the constant current conjugate
<span class="lineNum">     898 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   *IC = expandVector (*IC, nbanodes);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">     899 </span>                :            : 
<span class="lineNum">     900 </span>                :            :   // compute constant current vector for sources itself
<span class="lineNum">     901 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          1 :   IS = new tvector&lt;nr_complex_t&gt; (se);</span>
<span class="lineNum">     902 </span>                :            :   // .. | ..
<span class="lineNum">     903 </span>                :            :   // ---+---
<span class="lineNum">     904 </span>                :            :   // .. | YC * VC
<span class="lineNum">     905 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         10 :   for (r = 0; r &lt; se; r++) {</span>
<span class="lineNum">     906 </span>                :<span class="lineCov">          9 :     nr_complex_t i = 0.0;</span>
<span class="lineNum">     907 </span>        [<span class="branchCov" title="Branch 0 was taken 81 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">         90 :     for (c = 0; c &lt; se; c++) {</span>
<span class="lineNum">     908 </span>[<span class="branchCov" title="Branch 0 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         81 :       i += Y_(r + sn, c + sn) * VC (c);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">     909 </span>                :            :     }
<span class="lineNum">     910 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :     IS-&gt;set (r, i);</span>
<span class="lineNum">     911 </span>                :            :   }
<span class="lineNum">     912 </span>                :            : 
<span class="lineNum">     913 </span>                :            :   // delete overall transadmittance matrix
<span class="lineNum">     914 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   delete Y; Y = NULL;</span>
<span class="lineNum">     915 </span>                :<span class="lineCov">          1 : }</span>
<span class="lineNum">     916 </span>                :            : 
<a name="917"><span class="lineNum">     917 </span>                :            : /* Checks whether currents through the interconnects of the linear and</a>
<span class="lineNum">     918 </span>                :            :    non-linear subcircuit (in the frequency domain) are equal. */
<span class="lineNum">     919 </span>                :<span class="lineCov">         10 : int hbsolver::checkBalance (void) {</span>
<span class="lineNum">     920 </span>                :<span class="lineCov">         10 :   nr_double_t iabstol = getPropertyDouble (&quot;iabstol&quot;);</span>
<span class="lineNum">     921 </span>                :<span class="lineCov">         10 :   nr_double_t vabstol = getPropertyDouble (&quot;vabstol&quot;);</span>
<span class="lineNum">     922 </span>                :<span class="lineCov">         10 :   nr_double_t reltol = getPropertyDouble (&quot;reltol&quot;);</span>
<span class="lineNum">     923 </span>                :<span class="lineCov">         10 :   int n, len = FV-&gt;getSize ();</span>
<span class="lineNum">     924 </span>        [<span class="branchCov" title="Branch 0 was taken 25 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         35 :   for (n = 0; n &lt; len; n++) {</span>
<span class="lineNum">     925 </span>                :            :     // check iteration voltages
<span class="lineNum">     926 </span>[<span class="branchCov" title="Branch 0 was taken 25 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 25 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         25 :     nr_double_t v_abs = abs (VS-&gt;get (n) - VP-&gt;get (n));</span>
<span class="lineNum">     927 </span>        [<span class="branchCov" title="Branch 0 was taken 25 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         25 :     nr_double_t v_rel = abs (VS-&gt;get (n));</span>
<span class="lineNum">     928 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         25 :     if (v_abs &gt;= vabstol + reltol * v_rel) return 0;</span>
<span class="lineNum">     929 </span>                :            :     // check balanced currents
<span class="lineNum">     930 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         18 :     nr_complex_t il = IL-&gt;get (n);</span>
<span class="lineNum">     931 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         18 :     nr_complex_t in = IN-&gt;get (n);</span>
<span class="lineNum">     932 </span>[<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         18 :     if (il != in) {</span>
<span class="lineNum">     933 </span>                :<span class="lineCov">         18 :       nr_double_t i_abs = abs (il + in);</span>
<span class="lineNum">     934 </span>        [<span class="branchCov" title="Branch 2 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         18 :       nr_double_t i_rel = abs ((il + in) / (il - in));</span>
<span class="lineNum">     935 </span>[<span class="branchCov" title="Branch 0 was taken 16 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchCov" title="Branch 3 was taken 14 times"> + </span>]:<span class="lineCov">         18 :       if (i_abs &gt;= iabstol &amp;&amp; 2.0 * i_rel &gt;= reltol) return 0;</span>
<span class="lineNum">     936 </span>                :            :     }
<span class="lineNum">     937 </span>                :            :   }
<span class="lineNum">     938 </span>                :<span class="lineCov">         10 :   return 1;</span>
<span class="lineNum">     939 </span>                :            : }
<span class="lineNum">     940 </span>                :            : 
<span class="lineNum">     941 </span>                :            : // some definitions for the non-linear matrix filler
<span class="lineNum">     942 </span>                :            : #undef  G_
<span class="lineNum">     943 </span>                :            : #undef  C_
<span class="lineNum">     944 </span>                :            : #define G_(r,c) (*jg) ((r)*nlfreqs+f,(c)*nlfreqs+f)
<span class="lineNum">     945 </span>                :            : #define C_(r,c) (*jq) ((r)*nlfreqs+f,(c)*nlfreqs+f)
<span class="lineNum">     946 </span>                :            : #undef  FI_
<span class="lineNum">     947 </span>                :            : #undef  FQ_
<span class="lineNum">     948 </span>                :            : #define FI_(r) (*ig) ((r)*nlfreqs+f)
<span class="lineNum">     949 </span>                :            : #define FQ_(r) (*fq) ((r)*nlfreqs+f)
<span class="lineNum">     950 </span>                :            : #define IR_(r) (*ir) ((r)*nlfreqs+f)
<span class="lineNum">     951 </span>                :            : #define QR_(r) (*qr) ((r)*nlfreqs+f)
<span class="lineNum">     952 </span>                :            : 
<a name="953"><span class="lineNum">     953 </span>                :            : /* This function fills in the matrix and vector entries for the</a>
<span class="lineNum">     954 </span>                :            :    non-linear HB equations for a given frequency index. */
<span class="lineNum">     955 </span>                :<span class="lineCov">        176 : void hbsolver::fillMatrixNonLinear (tmatrix&lt;nr_complex_t&gt; * jg,</span>
<span class="lineNum">     956 </span>                :            :                                     tmatrix&lt;nr_complex_t&gt; * jq,
<span class="lineNum">     957 </span>                :            :                                     tvector&lt;nr_complex_t&gt; * ig,
<span class="lineNum">     958 </span>                :            :                                     tvector&lt;nr_complex_t&gt; * fq,
<span class="lineNum">     959 </span>                :            :                                     tvector&lt;nr_complex_t&gt; * ir,
<span class="lineNum">     960 </span>                :            :                                     tvector&lt;nr_complex_t&gt; * qr,
<span class="lineNum">     961 </span>                :            :                                     int f) {
<span class="lineNum">     962 </span>                :            :   // through each linear circuit
<span class="lineNum">     963 </span>        [<span class="branchCov" title="Branch 5 was taken 176 times"> + </span><span class="branchCov" title="Branch 6 was taken 176 times"> + </span>]:<span class="lineCov">        352 :   for (auto *cir: nolcircuits) {</span>
<span class="lineNum">     964 </span>                :<span class="lineCov">        176 :     int s = cir-&gt;getSize ();</span>
<span class="lineNum">     965 </span>                :            :     int nr, nc, r, c;
<span class="lineNum">     966 </span>                :            : 
<span class="lineNum">     967 </span>        [<span class="branchCov" title="Branch 0 was taken 352 times"> + </span><span class="branchCov" title="Branch 1 was taken 176 times"> + </span>]:<span class="lineCov">        528 :     for (r = 0; r &lt; s; r++) {</span>
<span class="lineNum">     968 </span>[<span class="branchCov" title="Branch 0 was taken 352 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 176 times"> + </span><span class="branchCov" title="Branch 5 was taken 176 times"> + </span>]:<span class="lineCov">        352 :       if ((nr = cir-&gt;getNode(r)-&gt;getNode () - 1) &lt; 0) continue;</span>
<span class="lineNum">     969 </span>                :            :       // apply G- and C-matrix entries
<span class="lineNum">     970 </span>        [<span class="branchCov" title="Branch 0 was taken 352 times"> + </span><span class="branchCov" title="Branch 1 was taken 176 times"> + </span>]:<span class="lineCov">        528 :       for (c = 0; c &lt; s; c++) {</span>
<span class="lineNum">     971 </span>[<span class="branchCov" title="Branch 0 was taken 352 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 176 times"> + </span><span class="branchCov" title="Branch 5 was taken 176 times"> + </span>]:<span class="lineCov">        352 :         if ((nc = cir-&gt;getNode(c)-&gt;getNode () - 1) &lt; 0) continue;</span>
<span class="lineNum">     972 </span>[<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        176 :         G_(nr, nc) += cir-&gt;getY (r, c);</span>
<span class="lineNum">     973 </span>[<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        176 :         C_(nr, nc) += cir-&gt;getQV (r, c);</span>
<span class="lineNum">     974 </span>                :            :       }
<span class="lineNum">     975 </span>                :            :       // apply I- and Q-vector entries
<span class="lineNum">     976 </span>[<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        176 :       FI_(nr) -= cir-&gt;getI (r);</span>
<span class="lineNum">     977 </span>[<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        176 :       FQ_(nr) -= cir-&gt;getQ (r);</span>
<span class="lineNum">     978 </span>                :            :       // ThinkME: positive or negative?
<span class="lineNum">     979 </span>[<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        176 :       IR_(nr) += cir-&gt;getGV (r) + cir-&gt;getI (r);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">     980 </span>[<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        176 :       QR_(nr) += cir-&gt;getCV (r) + cir-&gt;getQ (r);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">     981 </span>                :            :     }
<span class="lineNum">     982 </span>                :            :   }
<span class="lineNum">     983 </span>                :<span class="lineCov">        176 : }</span>
<a name="984"><span class="lineNum">     984 </span>                :            : </a>
<span class="lineNum">     985 </span>                :            : /* The function initializes the non-linear part of the HB. */
<span class="lineNum">     986 </span>                :<span class="lineCov">          1 : void hbsolver::prepareNonLinear (void) {</span>
<span class="lineNum">     987 </span>                :<span class="lineCov">          1 :   int N = nbanodes;</span>
<span class="lineNum">     988 </span>                :            : 
<span class="lineNum">     989 </span>                :            :   // allocate matrices and vectors
<span class="lineNum">     990 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (FQ == NULL) {</span>
<span class="lineNum">     991 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     FQ = new tvector&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">     992 </span>                :            :   }
<span class="lineNum">     993 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (IG == NULL) {</span>
<span class="lineNum">     994 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     IG = new tvector&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">     995 </span>                :            :   }
<span class="lineNum">     996 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (IR == NULL) {</span>
<span class="lineNum">     997 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     IR = new tvector&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">     998 </span>                :            :   }
<span class="lineNum">     999 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (QR == NULL) {</span>
<span class="lineNum">    1000 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     QR = new tvector&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">    1001 </span>                :            :   }
<span class="lineNum">    1002 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (JG == NULL) {</span>
<span class="lineNum">    1003 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     JG = new tmatrix&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">    1004 </span>                :            :   }
<span class="lineNum">    1005 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (JQ == NULL) {</span>
<span class="lineNum">    1006 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     JQ = new tmatrix&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">    1007 </span>                :            :   }
<span class="lineNum">    1008 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (JF == NULL) {</span>
<span class="lineNum">    1009 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     JF = new tmatrix&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">    1010 </span>                :            :   }
<span class="lineNum">    1011 </span>                :            : 
<span class="lineNum">    1012 </span>                :            :   // voltage vector in frequency and time domain
<span class="lineNum">    1013 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (VS == NULL) {</span>
<span class="lineNum">    1014 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     VS = new tvector&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">    1015 </span>                :            :   }
<span class="lineNum">    1016 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (vs == NULL) {</span>
<span class="lineNum">    1017 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     vs = new tvector&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">    1018 </span>                :            :   }
<span class="lineNum">    1019 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (VP == NULL) {</span>
<span class="lineNum">    1020 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     VP = new tvector&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">    1021 </span>                :            :   }
<span class="lineNum">    1022 </span>                :            : 
<span class="lineNum">    1023 </span>                :            :   // error vector
<span class="lineNum">    1024 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (FV == NULL) {</span>
<span class="lineNum">    1025 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     FV = new tvector&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">    1026 </span>                :            :   }
<span class="lineNum">    1027 </span>                :            :   // right hand side vector
<span class="lineNum">    1028 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (RH == NULL) {</span>
<span class="lineNum">    1029 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     RH = new tvector&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">    1030 </span>                :            :   }
<span class="lineNum">    1031 </span>                :            : 
<span class="lineNum">    1032 </span>                :            :   // linear and non-linear current vector
<span class="lineNum">    1033 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (IL == NULL) {</span>
<span class="lineNum">    1034 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     IL = new tvector&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">    1035 </span>                :            :   }
<span class="lineNum">    1036 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (IN == NULL) {</span>
<span class="lineNum">    1037 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     IN = new tvector&lt;nr_complex_t&gt; (N * nlfreqs);</span>
<span class="lineNum">    1038 </span>                :            :   }
<span class="lineNum">    1039 </span>                :            : 
<span class="lineNum">    1040 </span>                :            :   // assign nodes
<span class="lineNum">    1041 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   assignNodes (nolcircuits, nanodes);</span>
<span class="lineNum">    1042 </span>                :            : 
<span class="lineNum">    1043 </span>                :            :   // initialize circuits
<span class="lineNum">    1044 </span>        [<span class="branchCov" title="Branch 5 was taken 1 time"> + </span><span class="branchCov" title="Branch 6 was taken 1 time"> + </span>]:<span class="lineCov">          2 :   for (auto *cir : nolcircuits) {</span>
<span class="lineNum">    1045 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     cir-&gt;initHB (nlfreqs);</span>
<span class="lineNum">    1046 </span>                :            :   }
<span class="lineNum">    1047 </span>                :<span class="lineCov">          1 : }</span>
<span class="lineNum">    1048 </span>                :            : 
<a name="1049"><span class="lineNum">    1049 </span>                :            : /* Saves the node voltages of the given circuit and for the given</a>
<span class="lineNum">    1050 </span>                :            :    frequency entry into the circuit voltage vector. */
<span class="lineNum">    1051 </span>                :<span class="lineCov">        176 : void hbsolver::saveNodeVoltages (circuit * cir, int f) {</span>
<span class="lineNum">    1052 </span>                :<span class="lineCov">        176 :   int r, nr, s = cir-&gt;getSize ();</span>
<span class="lineNum">    1053 </span>        [<span class="branchCov" title="Branch 0 was taken 352 times"> + </span><span class="branchCov" title="Branch 1 was taken 176 times"> + </span>]:<span class="lineCov">        528 :   for (r = 0; r &lt; s; r++) {</span>
<span class="lineNum">    1054 </span>        [<span class="branchCov" title="Branch 2 was taken 176 times"> + </span><span class="branchCov" title="Branch 3 was taken 176 times"> + </span>]:<span class="lineCov">        352 :     if ((nr = cir-&gt;getNode(r)-&gt;getNode () - 1) &lt; 0) continue;</span>
<span class="lineNum">    1055 </span>                :            :     // apply V-vector entries
<span class="lineNum">    1056 </span>        [<span class="branchCov" title="Branch 3 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        176 :     cir-&gt;setV (r, real (vs-&gt;get (nr * nlfreqs + f)));</span>
<span class="lineNum">    1057 </span>                :            :   }
<span class="lineNum">    1058 </span>                :<span class="lineCov">        176 : }</span>
<span class="lineNum">    1059 </span>                :            : 
<span class="lineNum">    1060 </span>                :            : /* The function saves voltages into non-linear circuits, runs each
<a name="1061"><span class="lineNum">    1061 </span>                :            :    non-linear components' HB calculator for each frequency and applies</a>
<span class="lineNum">    1062 </span>                :            :    the matrix and vector entries appropriately. */
<span class="lineNum">    1063 </span>                :<span class="lineCov">         11 : void hbsolver::loadMatrices (void) {</span>
<span class="lineNum">    1064 </span>                :            :   // clear matrices and vectors before
<span class="lineNum">    1065 </span>                :<span class="lineCov">         11 :   IG-&gt;set (0.0);</span>
<span class="lineNum">    1066 </span>                :<span class="lineCov">         11 :   FQ-&gt;set (0.0);</span>
<span class="lineNum">    1067 </span>                :<span class="lineCov">         11 :   IR-&gt;set (0.0);</span>
<span class="lineNum">    1068 </span>                :<span class="lineCov">         11 :   QR-&gt;set (0.0);</span>
<span class="lineNum">    1069 </span>                :<span class="lineCov">         11 :   JG-&gt;set (0.0);</span>
<span class="lineNum">    1070 </span>                :<span class="lineCov">         11 :   JQ-&gt;set (0.0);</span>
<span class="lineNum">    1071 </span>                :            :   // through each frequency
<span class="lineNum">    1072 </span>        [<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>]:<span class="lineCov">        187 :   for (int f = 0; f &lt; nlfreqs; f++) {</span>
<span class="lineNum">    1073 </span>                :            :     // calculate components' HB matrices and vector for the given frequency
<span class="lineNum">    1074 </span>        [<span class="branchCov" title="Branch 5 was taken 176 times"> + </span><span class="branchCov" title="Branch 6 was taken 176 times"> + </span>]:<span class="lineCov">        352 :     for (auto *cir : nolcircuits) {</span>
<span class="lineNum">    1075 </span>        [<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        176 :       saveNodeVoltages (cir, f); // node voltages</span>
<span class="lineNum">    1076 </span>        [<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        176 :       cir-&gt;calcHB (f);         // HB calculator</span>
<span class="lineNum">    1077 </span>                :            :     }
<span class="lineNum">    1078 </span>                :            :     // fill in all matrix entries for the given frequency
<span class="lineNum">    1079 </span>                :<span class="lineCov">        176 :     fillMatrixNonLinear (JG, JQ, IG, FQ, IR, QR, f);</span>
<span class="lineNum">    1080 </span>                :            :   }
<span class="lineNum">    1081 </span>                :<span class="lineCov">         11 : }</span>
<span class="lineNum">    1082 </span>                :            : 
<a name="1083"><span class="lineNum">    1083 </span>                :            : /* The following function transforms a vector using a Fast Fourier</a>
<span class="lineNum">    1084 </span>                :            :    Transformation from the time domain to the frequency domain. */
<span class="lineNum">    1085 </span>                :<span class="lineCov">         74 : void hbsolver::VectorFFT (tvector&lt;nr_complex_t&gt; * V, int isign) {</span>
<span class="lineNum">    1086 </span>                :            :   int i, k, r;
<span class="lineNum">    1087 </span>                :<span class="lineCov">         74 :   int n = nlfreqs;</span>
<span class="lineNum">    1088 </span>                :<span class="lineCov">         74 :   int nd = dfreqs.getSize ();</span>
<span class="lineNum">    1089 </span>                :<span class="lineCov">         74 :   int nodes = V-&gt;getSize () / n;</span>
<span class="lineNum">    1090 </span>                :<span class="lineCov">         74 :   nr_double_t * d = (nr_double_t *) V-&gt;getData ();</span>
<span class="lineNum">    1091 </span>                :            : 
<span class="lineNum">    1092 </span>        [<span class="branchCov" title="Branch 0 was taken 74 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         74 :   if (nd == 1) {</span>
<span class="lineNum">    1093 </span>                :            :     // for each node a single 1d-FFT
<span class="lineNum">    1094 </span>        [<span class="branchCov" title="Branch 0 was taken 74 times"> + </span><span class="branchCov" title="Branch 1 was taken 74 times"> + </span>]:<span class="lineCov">        148 :     for (k = i = 0; i &lt; nodes; i++, k += 2 * n) {</span>
<span class="lineNum">    1095 </span>                :<span class="lineCov">         74 :       nr_double_t * dst = &amp;d[k];</span>
<span class="lineNum">    1096 </span>                :<span class="lineCov">         74 :       _fft_1d (dst, n, isign);</span>
<span class="lineNum">    1097 </span>[<span class="branchCov" title="Branch 0 was taken 64 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 2048 times"> + </span><span class="branchCov" title="Branch 3 was taken 64 times"> + </span>]:<span class="lineCov">       2122 :       if (isign &gt; 0) for (r = 0; r &lt; 2 * n; r++) *dst++ /= n;</span>
<span class="lineNum">    1098 </span>                :            :     }
<span class="lineNum">    1099 </span>                :            :   }
<span class="lineNum">    1100 </span>                :            :   else {
<span class="lineNum">    1101 </span>                :            :     // for each node a single nd-FFT
<span class="lineNum">    1102 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (k = i = 0; i &lt; nodes; i++, k += 2 * n) {</span>
<span class="lineNum">    1103 </span>                :<span class="lineNoCov">          0 :       nr_double_t * dst = &amp;d[k];</span>
<span class="lineNum">    1104 </span>                :<span class="lineNoCov">          0 :       _fft_nd (dst, ndfreqs, nd, isign);</span>
<span class="lineNum">    1105 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :       if (isign &gt; 0) for (r = 0; r &lt; 2 * n; r++) *dst++ /= ndfreqs[0];</span>
<span class="lineNum">    1106 </span>                :            :     }
<span class="lineNum">    1107 </span>                :            :   }
<span class="lineNum">    1108 </span>                :<span class="lineCov">         74 : }</span>
<span class="lineNum">    1109 </span>                :            : 
<span class="lineNum">    1110 </span>                :            : /* The following function transforms a vector using an Inverse Fast
<a name="1111"><span class="lineNum">    1111 </span>                :            :    Fourier Transformation from the frequency domain to the domain</a>
<span class="lineNum">    1112 </span>                :            :    time. */
<span class="lineNum">    1113 </span>                :<span class="lineCov">         10 : void hbsolver::VectorIFFT (tvector&lt;nr_complex_t&gt; * V, int isign) {</span>
<span class="lineNum">    1114 </span>                :<span class="lineCov">         10 :   VectorFFT (V, -isign);</span>
<span class="lineNum">    1115 </span>                :<span class="lineCov">         10 : }</span>
<span class="lineNum">    1116 </span>                :            : 
<a name="1117"><span class="lineNum">    1117 </span>                :            : /* The following function transforms a matrix using a Fast Fourier</a>
<span class="lineNum">    1118 </span>                :            :    Transformation from the time domain to the frequency domain. */
<span class="lineNum">    1119 </span>                :<span class="lineCov">         20 : void hbsolver::MatrixFFT (tmatrix&lt;nr_complex_t&gt; * M) {</span>
<span class="lineNum">    1120 </span>                :            : 
<span class="lineNum">    1121 </span>                :            : #if THE_SLO_ALGO
<span class="lineNum">    1122 </span>                :            :   // each column FFT
<span class="lineNum">    1123 </span>                :            :   for (int c = 0; c &lt; M-&gt;getCols (); c++) {
<span class="lineNum">    1124 </span>                :            :     tvector&lt;nr_complex_t&gt; V = M-&gt;getCol (c);
<span class="lineNum">    1125 </span>                :            :     VectorFFT (&amp;V);
<span class="lineNum">    1126 </span>                :            :     M-&gt;setCol (c, V);
<span class="lineNum">    1127 </span>                :            :   }
<span class="lineNum">    1128 </span>                :            : 
<span class="lineNum">    1129 </span>                :            :   // each row IFFT
<span class="lineNum">    1130 </span>                :            :   for (int r = 0; r &lt; M-&gt;getRows (); r++) {
<span class="lineNum">    1131 </span>                :            :     tvector&lt;nr_complex_t&gt; V = M-&gt;getRow (r);
<span class="lineNum">    1132 </span>                :            :     VectorIFFT (&amp;V);
<span class="lineNum">    1133 </span>                :            :     M-&gt;setRow (r, V);
<span class="lineNum">    1134 </span>                :            :   }
<span class="lineNum">    1135 </span>                :            : #else
<span class="lineNum">    1136 </span>                :            :   int c, r, nc, nr;
<span class="lineNum">    1137 </span>                :            :   // for each non-linear node block
<span class="lineNum">    1138 </span>        [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">         40 :   for (nc = c = 0; c &lt; nbanodes; c++, nc += nlfreqs) {</span>
<span class="lineNum">    1139 </span>        [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">         40 :     for (nr = r = 0; r &lt; nbanodes; r++, nr += nlfreqs) {</span>
<span class="lineNum">    1140 </span>        [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         20 :       tvector&lt;nr_complex_t&gt; V (nlfreqs);</span>
<span class="lineNum">    1141 </span>                :            :       int fr, fc, fi;
<span class="lineNum">    1142 </span>                :            :       // transform the sub-diagonal only
<span class="lineNum">    1143 </span>[<span class="branchCov" title="Branch 0 was taken 320 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 320 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        340 :       for (fc = 0; fc &lt; nlfreqs; fc++) V (fc) = M-&gt;get (nr + fc, nc + fc);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 320 times"> + </span><span class="branchCov" title="Branch 7 was taken 20 times"> + </span>]
<span class="lineNum">    1144 </span>        [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         20 :       VectorFFT (&amp;V);</span>
<span class="lineNum">    1145 </span>                :            :       // fill in resulting sub-matrix for the node
<span class="lineNum">    1146 </span>        [<span class="branchCov" title="Branch 0 was taken 320 times"> + </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">        340 :       for (fc = 0; fc &lt; nlfreqs; fc++) {</span>
<span class="lineNum">    1147 </span>        [<span class="branchCov" title="Branch 0 was taken 5120 times"> + </span><span class="branchCov" title="Branch 1 was taken 320 times"> + </span>]:<span class="lineCov">       5440 :         for (fi = nlfreqs - 1 - fc, fr = 0; fr &lt; nlfreqs; fr++) {</span>
<span class="lineNum">    1148 </span>        [<span class="branchCov" title="Branch 0 was taken 320 times"> + </span><span class="branchCov" title="Branch 1 was taken 4800 times"> + </span>]:<span class="lineCov">       5120 :           if (++fi &gt;= nlfreqs) fi = 0;</span>
<span class="lineNum">    1149 </span>[<span class="branchCov" title="Branch 0 was taken 5120 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 5120 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       5120 :           M-&gt;set (nr + fr, nc + fc, V (fi));</span>
<span class="lineNum">    1150 </span>                :            :         }
<span class="lineNum">    1151 </span>                :            :       }
<span class="lineNum">    1152 </span>                :<span class="lineCov">         20 :     }</span>
<span class="lineNum">    1153 </span>                :            :   }
<span class="lineNum">    1154 </span>                :            : #endif
<span class="lineNum">    1155 </span>                :<span class="lineCov">         20 : }</span>
<span class="lineNum">    1156 </span>                :            : 
<span class="lineNum">    1157 </span>                :            : /* This function solves the actual HB equation in the frequency domain.
<span class="lineNum">    1158 </span>                :            :    F(V) = IC + [YV] * VS + j[O] * FQ + IG -&gt; 0
<span class="lineNum">    1159 </span>                :            :    Care must be taken with indexing here: In the frequency domain only
<span class="lineNum">    1160 </span>                :            :    real positive frequencies are used and computed, but in the time
<span class="lineNum">    1161 </span>                :            :    domain we have more values because of the periodic continuation in
<span class="lineNum">    1162 </span>                :            :    the frequency domain.
<span class="lineNum">    1163 </span>                :            :    RHS = j[O] * CV + GV - (IC + j[O] * FQ + IG)
<a name="1164"><span class="lineNum">    1164 </span>                :            :    Also the right hand side of the equation system for the new voltage</a>
<span class="lineNum">    1165 </span>                :            :    vector is computed here. */
<span class="lineNum">    1166 </span>                :<span class="lineCov">         11 : void hbsolver::solveHB (void) {</span>
<span class="lineNum">    1167 </span>                :            :   // for each non-linear node
<span class="lineNum">    1168 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>]:<span class="lineCov">         22 :   for (int r = 0; r &lt; nbanodes * nlfreqs; ) {</span>
<span class="lineNum">    1169 </span>                :            :     // for each frequency
<span class="lineNum">    1170 </span>        [<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>]:<span class="lineCov">        187 :     for (int f = 0; f &lt; nlfreqs; f++, r++) {</span>
<span class="lineNum">    1171 </span>                :<span class="lineCov">        176 :       nr_complex_t il = 0.0, in = 0.0, ir = 0.0;</span>
<span class="lineNum">    1172 </span>                :            :       // constant current vector due to sources
<span class="lineNum">    1173 </span>        [<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        176 :       il += IC-&gt;get (r);</span>
<span class="lineNum">    1174 </span>                :            :       // part 1 of right hand side vector
<span class="lineNum">    1175 </span>                :<span class="lineCov">        176 :       ir -= il;</span>
<span class="lineNum">    1176 </span>                :            :       // transadmittance matrix multiplied by voltage vector
<span class="lineNum">    1177 </span>        [<span class="branchCov" title="Branch 0 was taken 2816 times"> + </span><span class="branchCov" title="Branch 1 was taken 176 times"> + </span>]:<span class="lineCov">       2992 :       for (int c = 0; c &lt; nbanodes * nlfreqs; c++) {</span>
<span class="lineNum">    1178 </span>[<span class="branchCov" title="Branch 0 was taken 2816 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 2816 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       2816 :         il += YV_(r, c) * VS_(c);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 2816 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">    1179 </span>                :            :       }
<span class="lineNum">    1180 </span>                :            :       // charge vector
<span class="lineNum">    1181 </span>[<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        176 :       in += OM_(f) * FQ-&gt;get (r);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">    1182 </span>                :            :       // current vector
<span class="lineNum">    1183 </span>        [<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        176 :       in += IG-&gt;get (r);</span>
<span class="lineNum">    1184 </span>                :            :       // part 2, 3 and 4 of right hand side vector
<span class="lineNum">    1185 </span>        [<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        176 :       ir += IR-&gt;get (r);</span>
<span class="lineNum">    1186 </span>[<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">        176 :       ir += OM_(f) * QR-&gt;get (r);</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">    1187 </span>                :            :       // put values into result vectors
<span class="lineNum">    1188 </span>        [<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        176 :       RH-&gt;set (r, ir);</span>
<span class="lineNum">    1189 </span>        [<span class="branchCov" title="Branch 1 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        176 :       FV-&gt;set (r, il + in);</span>
<span class="lineNum">    1190 </span>        [<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        176 :       IL-&gt;set (r, il);</span>
<span class="lineNum">    1191 </span>        [<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        176 :       IN-&gt;set (r, in);</span>
<span class="lineNum">    1192 </span>                :            :     }
<span class="lineNum">    1193 </span>                :            :   }
<span class="lineNum">    1194 </span>                :<span class="lineCov">         11 : }</span>
<a name="1195"><span class="lineNum">    1195 </span>                :            : </a>
<span class="lineNum">    1196 </span>                :            : /* The function calculates the full Jacobian JF = [YV] + j[O] * JQ + JG */
<span class="lineNum">    1197 </span>                :<span class="lineCov">         10 : void hbsolver::calcJacobian (void) {</span>
<span class="lineNum">    1198 </span>                :            :   int c, r, fc, fr, rt, ct;
<span class="lineNum">    1199 </span>                :            :   /* add admittances of capacitance matrix JQ and non-linear
<span class="lineNum">    1200 </span>                :            :      admittances matrix JG into complete Jacobian JF */
<span class="lineNum">    1201 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         20 :   for (c = 0; c &lt; nbanodes; c++) {</span>
<span class="lineNum">    1202 </span>                :<span class="lineCov">         10 :     ct = c * nlfreqs;</span>
<span class="lineNum">    1203 </span>        [<span class="branchCov" title="Branch 0 was taken 160 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">        170 :     for (fc = 0; fc &lt; nlfreqs; fc++, ct++) {</span>
<span class="lineNum">    1204 </span>        [<span class="branchCov" title="Branch 0 was taken 160 times"> + </span><span class="branchCov" title="Branch 1 was taken 160 times"> + </span>]:<span class="lineCov">        320 :       for (r = 0; r &lt; nbanodes; r++) {</span>
<span class="lineNum">    1205 </span>                :<span class="lineCov">        160 :         rt = r * nlfreqs;</span>
<span class="lineNum">    1206 </span>        [<span class="branchCov" title="Branch 0 was taken 2560 times"> + </span><span class="branchCov" title="Branch 1 was taken 160 times"> + </span>]:<span class="lineCov">       2720 :         for (fr = 0; fr &lt; nlfreqs; fr++, rt++) {</span>
<span class="lineNum">    1207 </span>[<span class="branchCov" title="Branch 3 was taken 2560 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 2560 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]:<span class="lineCov">       2560 :           JF_(rt, ct) = JG-&gt;get (rt, ct) + JQ-&gt;get (rt, ct) * OM_(fr);</span>
<span class="lineNum">    1208 </span>                :            :         }
<span class="lineNum">    1209 </span>                :            :       }
<span class="lineNum">    1210 </span>                :            :     }
<span class="lineNum">    1211 </span>                :            :   }
<span class="lineNum">    1212 </span>        [<span class="branchCov" title="Branch 1 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         10 :   *JF += *YV; // add linear admittance matrix</span>
<span class="lineNum">    1213 </span>                :<span class="lineCov">         10 : }</span>
<span class="lineNum">    1214 </span>                :            : 
<a name="1215"><span class="lineNum">    1215 </span>                :            : /* The function expands the given vector in the frequency domain to</a>
<span class="lineNum">    1216 </span>                :            :    make it a real valued signal in the time domain. */
<span class="lineNum">    1217 </span>                :<span class="lineCov">          1 : tvector&lt;nr_complex_t&gt; hbsolver::expandVector (tvector&lt;nr_complex_t&gt; V,</span>
<span class="lineNum">    1218 </span>                :            :                                               int nodes) {
<span class="lineNum">    1219 </span>                :<span class="lineCov">          1 :   tvector&lt;nr_complex_t&gt; res (nodes * nlfreqs);</span>
<span class="lineNum">    1220 </span>                :            :   int r, ff, rf, rt;
<span class="lineNum">    1221 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          2 :   for (r = 0; r &lt; nodes; r++) {</span>
<span class="lineNum">    1222 </span>                :<span class="lineCov">          1 :     rt = r * nlfreqs;</span>
<span class="lineNum">    1223 </span>                :<span class="lineCov">          1 :     rf = r * lnfreqs;</span>
<span class="lineNum">    1224 </span>                :            :     // copy first part of vector
<span class="lineNum">    1225 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         10 :     for (ff = 0; ff &lt; lnfreqs; ff++, rf++, rt++) {</span>
<span class="lineNum">    1226 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          9 :       res (rt) = V (rf);</span>
<span class="lineNum">    1227 </span>                :            :     }
<span class="lineNum">    1228 </span>                :            :     // continue vector conjugated
<span class="lineNum">    1229 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          8 :     for (rf -= 2; ff &lt; nlfreqs; ff++, rf--, rt++) {</span>
<span class="lineNum">    1230 </span>[<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          7 :       res (rt) = conj (V (rf));</span>
<span class="lineNum">    1231 </span>                :            :     }
<span class="lineNum">    1232 </span>                :            :   }
<span class="lineNum">    1233 </span>                :<span class="lineCov">          1 :   return res;</span>
<span class="lineNum">    1234 </span>                :            : }
<span class="lineNum">    1235 </span>                :            : 
<a name="1236"><span class="lineNum">    1236 </span>                :            : /* The function expands the given matrix in the frequency domain to</a>
<span class="lineNum">    1237 </span>                :            :    make it a real valued signal in the time domain. */
<span class="lineNum">    1238 </span>                :<span class="lineCov">          1 : tmatrix&lt;nr_complex_t&gt; hbsolver::expandMatrix (tmatrix&lt;nr_complex_t&gt; M,</span>
<span class="lineNum">    1239 </span>                :            :                                               int nodes) {
<span class="lineNum">    1240 </span>                :<span class="lineCov">          1 :   tmatrix&lt;nr_complex_t&gt; res (nodes * nlfreqs);</span>
<span class="lineNum">    1241 </span>                :            :   int r, c, rf, rt, cf, ct, ff;
<span class="lineNum">    1242 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          2 :   for (r = 0; r &lt; nodes; r++) {</span>
<span class="lineNum">    1243 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          2 :     for (c = 0; c &lt; nodes; c++) {</span>
<span class="lineNum">    1244 </span>                :<span class="lineCov">          1 :       rf = r * lnfreqs;</span>
<span class="lineNum">    1245 </span>                :<span class="lineCov">          1 :       rt = r * nlfreqs;</span>
<span class="lineNum">    1246 </span>                :<span class="lineCov">          1 :       cf = c * lnfreqs;</span>
<span class="lineNum">    1247 </span>                :<span class="lineCov">          1 :       ct = c * nlfreqs;</span>
<span class="lineNum">    1248 </span>                :            :       // copy first part of diagonal
<span class="lineNum">    1249 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         10 :       for (ff = 0; ff &lt; lnfreqs; ff++, cf++, ct++, rf++, rt++) {</span>
<span class="lineNum">    1250 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          9 :         res (rt, ct) = M (rf, cf);</span>
<span class="lineNum">    1251 </span>                :            :       }
<span class="lineNum">    1252 </span>                :            :       // continue diagonal conjugated
<span class="lineNum">    1253 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          8 :       for (cf -= 2, rf -= 2; ff &lt; nlfreqs; ff++, cf--, ct++, rf--, rt++) {</span>
<span class="lineNum">    1254 </span>[<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          7 :         res (rt, ct) = conj (M (rf, cf));</span>
<span class="lineNum">    1255 </span>                :            :       }
<span class="lineNum">    1256 </span>                :            :     }
<span class="lineNum">    1257 </span>                :            :   }
<span class="lineNum">    1258 </span>                :<span class="lineCov">          1 :   return res;</span>
<span class="lineNum">    1259 </span>                :            : }
<span class="lineNum">    1260 </span>                :            : 
<span class="lineNum">    1261 </span>                :            : /* This function solves the equation system
<a name="1262"><span class="lineNum">    1262 </span>                :            :    JF * VS(n+1) = JF * VS(n) - FV</a>
<span class="lineNum">    1263 </span>                :            :    in order to obtains a new voltage vector in the frequency domain. */
<span class="lineNum">    1264 </span>                :<span class="lineCov">         10 : void hbsolver::solveVoltages (void) {</span>
<span class="lineNum">    1265 </span>                :            :   // save previous iteration voltage
<span class="lineNum">    1266 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         10 :   *VP = *VS;</span>
<span class="lineNum">    1267 </span>                :            : 
<span class="lineNum">    1268 </span>                :            :   // setup equation system
<span class="lineNum">    1269 </span>                :<span class="lineCov">         10 :   eqnsys&lt;nr_complex_t&gt; eqns;</span>
<span class="lineNum">    1270 </span>                :            :   try_running () {
<span class="lineNum">    1271 </span>                :            :     // use LU decomposition for solving
<span class="lineNum">    1272 </span>                :<span class="lineCov">         10 :     eqns.setAlgo (ALGO_LU_DECOMPOSITION);</span>
<span class="lineNum">    1273 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         10 :     eqns.passEquationSys (JF, VS, RH);</span>
<span class="lineNum">    1274 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         10 :     eqns.solve ();</span>
<span class="lineNum">    1275 </span>                :            :   }
<span class="lineNum">    1276 </span>                :            :   // appropriate exception handling
<span class="lineNum">    1277 </span>[<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 10 times"> + </span>]:<span class="lineCov">         10 :   catch_exception () {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">    1278 </span>                :            :   case EXCEPTION_PIVOT:
<span class="lineNum">    1279 </span>                :            :   default:
<span class="lineNum">    1280 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :     logprint (LOG_ERROR, &quot;WARNING: %s: during NR iteration\n&quot;, getName ());</span>
<span class="lineNum">    1281 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     estack.print ();</span>
<span class="lineNum">    1282 </span>                :            :   }
<span class="lineNum">    1283 </span>                :            : 
<span class="lineNum">    1284 </span>                :            :   // save new voltages in time domain vector
<span class="lineNum">    1285 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         10 :   *vs = *VS;</span>
<span class="lineNum">    1286 </span>                :<span class="lineCov">         10 : }</span>
<span class="lineNum">    1287 </span>                :            : 
<span class="lineNum">    1288 </span>                :            : /* The following function extends the existing linear MNA matrix to
<a name="1289"><span class="lineNum">    1289 </span>                :            :    contain the additional rows and columns for the excitation voltage</a>
<span class="lineNum">    1290 </span>                :            :    sources. */
<span class="lineNum">    1291 </span>                :<span class="lineCov">          1 : tmatrix&lt;nr_complex_t&gt; hbsolver::extendMatrixLinear (tmatrix&lt;nr_complex_t&gt; M,</span>
<span class="lineNum">    1292 </span>                :            :                                                     int nodes) {
<span class="lineNum">    1293 </span>                :<span class="lineCov">          1 :   int no = M.getCols ();</span>
<span class="lineNum">    1294 </span>                :<span class="lineCov">          1 :   tmatrix&lt;nr_complex_t&gt; res (no + nodes * lnfreqs);</span>
<span class="lineNum">    1295 </span>                :            :   // copy the existing part
<span class="lineNum">    1296 </span>        [<span class="branchCov" title="Branch 0 was taken 45 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         46 :   for (int r = 0; r &lt; no; r++) {</span>
<span class="lineNum">    1297 </span>        [<span class="branchCov" title="Branch 0 was taken 2025 times"> + </span><span class="branchCov" title="Branch 1 was taken 45 times"> + </span>]:<span class="lineCov">       2070 :     for (int c = 0; c &lt; no; c++) {</span>
<span class="lineNum">    1298 </span>[<span class="branchCov" title="Branch 0 was taken 2025 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 2025 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       2025 :       res (r, c) = M (r, c);</span>
<span class="lineNum">    1299 </span>                :            :     }
<span class="lineNum">    1300 </span>                :            :   }
<span class="lineNum">    1301 </span>                :<span class="lineCov">          1 :   return res;</span>
<span class="lineNum">    1302 </span>                :            : }
<span class="lineNum">    1303 </span>                :            : 
<span class="lineNum">    1304 </span>                :            : /* The function fills in the missing MNA entries for the excitation
<a name="1305"><span class="lineNum">    1305 </span>                :            :    voltage sources into the extended rows and columns as well as the</a>
<span class="lineNum">    1306 </span>                :            :    actual voltage values into the right hand side vector. */
<span class="lineNum">    1307 </span>                :<span class="lineCov">          1 : void hbsolver::fillMatrixLinearExtended (tmatrix&lt;nr_complex_t&gt; * Y,</span>
<span class="lineNum">    1308 </span>                :            :                                          tvector&lt;nr_complex_t&gt; * I) {
<span class="lineNum">    1309 </span>                :            :   // through each excitation source
<span class="lineNum">    1310 </span>                :<span class="lineCov">          1 :   int of = lnfreqs * (nlnvsrcs + nnanodes);</span>
<span class="lineNum">    1311 </span>                :<span class="lineCov">          1 :   int sc = of;</span>
<span class="lineNum">    1312 </span>                :            : 
<span class="lineNum">    1313 </span>        [<span class="branchCov" title="Branch 5 was taken 1 time"> + </span><span class="branchCov" title="Branch 6 was taken 1 time"> + </span>]:<span class="lineCov">          2 :   for (auto *vs : excitations) {</span>
<span class="lineNum">    1314 </span>                :            :     // get positive and negative node
<span class="lineNum">    1315 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     int pnode = vs-&gt;getNode(NODE_1)-&gt;getNode ();</span>
<span class="lineNum">    1316 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     int nnode = vs-&gt;getNode(NODE_2)-&gt;getNode ();</span>
<span class="lineNum">    1317 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         10 :     for (int f = 0; f &lt; lnfreqs; f++, sc++) { // for each frequency</span>
<span class="lineNum">    1318 </span>                :            :       // fill right hand side vector
<span class="lineNum">    1319 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :       nr_double_t freq = rfreqs (f);</span>
<span class="lineNum">    1320 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :       vs-&gt;calcHB (freq);</span>
<span class="lineNum">    1321 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          9 :       I_(sc) = vs-&gt;getE (VSRC_1);</span>
<span class="lineNum">    1322 </span>                :            :       // fill MNA entries
<span class="lineNum">    1323 </span>                :<span class="lineCov">          9 :       int pn = (pnode - 1) * lnfreqs + f;</span>
<span class="lineNum">    1324 </span>                :<span class="lineCov">          9 :       int nn = (nnode - 1) * lnfreqs + f;</span>
<span class="lineNum">    1325 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :       if (pnode) {</span>
<span class="lineNum">    1326 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :         Y_(pn, sc) = +1.0;</span>
<span class="lineNum">    1327 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :         Y_(sc, pn) = +1.0;</span>
<span class="lineNum">    1328 </span>                :            :       }
<span class="lineNum">    1329 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">          9 :       if (nnode) {</span>
<span class="lineNum">    1330 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         Y_(nn, sc) = -1.0;</span>
<span class="lineNum">    1331 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         Y_(sc, nn) = -1.0;</span>
<span class="lineNum">    1332 </span>                :            :       }
<span class="lineNum">    1333 </span>                :            :     }
<span class="lineNum">    1334 </span>                :            :   }
<span class="lineNum">    1335 </span>                :<span class="lineCov">          1 : }</span>
<a name="1336"><span class="lineNum">    1336 </span>                :            : </a>
<span class="lineNum">    1337 </span>                :            : /* The function calculates and saves the final solution. */
<span class="lineNum">    1338 </span>                :<span class="lineCov">          1 : void hbsolver::finalSolution (void) {</span>
<span class="lineNum">    1339 </span>                :            : 
<span class="lineNum">    1340 </span>                :            :   // extend the linear MNA matrix
<span class="lineNum">    1341 </span>[<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          1 :   *NA = extendMatrixLinear (*NA, nnlvsrcs);</span>
<span class="lineNum">    1342 </span>                :            : 
<span class="lineNum">    1343 </span>                :<span class="lineCov">          1 :   int S = NA-&gt;getCols ();</span>
<span class="lineNum">    1344 </span>                :<span class="lineCov">          1 :   int N = nnanodes * lnfreqs;</span>
<span class="lineNum">    1345 </span>                :            : 
<span class="lineNum">    1346 </span>                :            :   // right hand side vector
<span class="lineNum">    1347 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   tvector&lt;nr_complex_t&gt; * I = new tvector&lt;nr_complex_t&gt; (S);</span>
<span class="lineNum">    1348 </span>                :            :   // temporary solution
<span class="lineNum">    1349 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   tvector&lt;nr_complex_t&gt; * V = new tvector&lt;nr_complex_t&gt; (S);</span>
<span class="lineNum">    1350 </span>                :            :   // final solution
<span class="lineNum">    1351 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   x = new tvector&lt;nr_complex_t&gt; (N);</span>
<span class="lineNum">    1352 </span>                :            : 
<span class="lineNum">    1353 </span>                :            :   // fill in missing MNA entries
<span class="lineNum">    1354 </span>                :<span class="lineCov">          1 :   fillMatrixLinearExtended (NA, I);</span>
<span class="lineNum">    1355 </span>                :            : 
<span class="lineNum">    1356 </span>                :            :   // put currents through balanced nodes into right hand side
<span class="lineNum">    1357 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          2 :   for (int n = 0; n &lt; nbanodes; n++) {</span>
<span class="lineNum">    1358 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         10 :     for (int f = 0; f &lt; lnfreqs; f++) {</span>
<span class="lineNum">    1359 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :       nr_complex_t i = IL-&gt;get (n * nlfreqs + f);</span>
<span class="lineNum">    1360 </span>[<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>][<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>]:<span class="lineCov">          9 :       if (f != 0 &amp;&amp; f != lnfreqs - 1) i *= 2;</span>
<span class="lineNum">    1361 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :       I_(n * lnfreqs + f) = i;</span>
<span class="lineNum">    1362 </span>                :            :     }
<span class="lineNum">    1363 </span>                :            :   }
<span class="lineNum">    1364 </span>                :            : 
<span class="lineNum">    1365 </span>                :            :   // use QR decomposition for the final solution
<span class="lineNum">    1366 </span>                :            :   try_running () {
<span class="lineNum">    1367 </span>                :<span class="lineCov">          1 :     eqnsys&lt;nr_complex_t&gt; eqns;</span>
<span class="lineNum">    1368 </span>                :<span class="lineCov">          1 :     eqns.setAlgo (ALGO_LU_DECOMPOSITION);</span>
<span class="lineNum">    1369 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     eqns.passEquationSys (NA, V, I);</span>
<span class="lineNum">    1370 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     eqns.solve ();</span>
<span class="lineNum">    1371 </span>                :            :   }
<span class="lineNum">    1372 </span>                :            :   // appropriate exception handling
<span class="lineNum">    1373 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          1 :   catch_exception () {</span>
<span class="lineNum">    1374 </span>                :            :   case EXCEPTION_PIVOT:
<span class="lineNum">    1375 </span>                :            :   default:
<span class="lineNum">    1376 </span>                :            :     logprint (LOG_ERROR, &quot;WARNING: %s: during final AC analysis\n&quot;,
<span class="lineNum">    1377 </span>                :<span class="lineNoCov">          0 :               getName ());</span>
<span class="lineNum">    1378 </span>                :<span class="lineNoCov">          0 :     estack.print ();</span>
<span class="lineNum">    1379 </span>                :            :   }
<span class="lineNum">    1380 </span>        [<span class="branchCov" title="Branch 2 was taken 27 times"> + </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>]:<span class="lineCov">         28 :   for (int i = 0; i &lt; N; i++) x-&gt;set (i, V_(i));</span>
<span class="lineNum">    1381 </span>                :<span class="lineCov">          1 : }</span>
<a name="1382"><span class="lineNum">    1382 </span>                :            : </a>
<span class="lineNum">    1383 </span>                :            : // Saves simulation results.
<span class="lineNum">    1384 </span>                :<span class="lineCov">          1 : void hbsolver::saveResults (void) {</span>
<span class="lineNum">    1385 </span>                :            :   vector * f;
<span class="lineNum">    1386 </span>                :            :   // add current frequency to the dependency of the output dataset
<span class="lineNum">    1387 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   if ((f = data-&gt;findDependency (&quot;hbfrequency&quot;)) == NULL) {</span>
<span class="lineNum">    1388 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :     f = new vector (&quot;hbfrequency&quot;);</span>
<span class="lineNum">    1389 </span>                :<span class="lineCov">          1 :     data-&gt;addDependency (f);</span>
<span class="lineNum">    1390 </span>                :            :   }
<span class="lineNum">    1391 </span>                :            :   // save frequency vector
<span class="lineNum">    1392 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (runs == 1) {</span>
<span class="lineNum">    1393 </span>[<span class="branchCov" title="Branch 2 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>][<span class="branchCov" title="Branch 5 was taken 9 times"> + </span><span class="branchCov" title="Branch 6 was taken 1 time"> + </span>]:<span class="lineCov">         10 :     for (int i = 0; i &lt; lnfreqs; i++) f-&gt;add (rfreqs (i));</span>
<span class="lineNum">    1394 </span>                :            :   }
<span class="lineNum">    1395 </span>                :            :   // save node voltage vectors
<span class="lineNum">    1396 </span>                :<span class="lineCov">          1 :   int nanode = 0;</span>
<span class="lineNum">    1397 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          4 :   for (strlistiterator it (nanodes); *it; ++it, nanode++) {</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 6 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>][<span class="branchCov" title="Branch 9 was taken 3 times"> + </span><span class="branchCov" title="Branch 10 was taken 1 time"> + </span>]
<span class="lineNum">    1398 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :     int l = strlen (*it);</span>
<span class="lineNum">    1399 </span>                :<span class="lineCov">          3 :     char * n = (char *) malloc (l + 4);</span>
<span class="lineNum">    1400 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :     sprintf (n, &quot;%s.Vb&quot;, *it);</span>
<span class="lineNum">    1401 </span>        [<span class="branchCov" title="Branch 0 was taken 27 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">         30 :     for (int i = 0; i &lt; lnfreqs; i++) {</span>
<span class="lineNum">    1402 </span>[<span class="branchCov" title="Branch 0 was taken 27 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 27 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         27 :       saveVariable (n, x-&gt;get (i + nanode * lnfreqs), f);</span>
<span class="lineNum">    1403 </span>                :            :     }
<span class="lineNum">    1404 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   }</span>
<span class="lineNum">    1405 </span>                :<span class="lineCov">          1 : }</span>
<span class="lineNum">    1406 </span>                :            : 
<span class="lineNum">    1407 </span>                :            : // properties
<span class="lineNum">    1408 </span>                :            : PROP_REQ [] = {
<span class="lineNum">    1409 </span>                :            :   { &quot;n&quot;, PROP_INT, { 1, PROP_NO_STR }, PROP_MIN_VAL (1) },
<span class="lineNum">    1410 </span>                :            :   PROP_NO_PROP };
<span class="lineNum">    1411 </span>                :            : PROP_OPT [] = {
<span class="lineNum">    1412 </span>                :            :   { &quot;f&quot;, PROP_REAL, { 1e9, PROP_NO_STR }, PROP_POS_RANGEX },
<span class="lineNum">    1413 </span>                :            :   { &quot;iabstol&quot;, PROP_REAL, { 1e-12, PROP_NO_STR }, PROP_RNG_X01I },
<span class="lineNum">    1414 </span>                :            :   { &quot;vabstol&quot;, PROP_REAL, { 1e-6, PROP_NO_STR }, PROP_RNG_X01I },
<span class="lineNum">    1415 </span>                :            :   { &quot;reltol&quot;, PROP_REAL, { 1e-3, PROP_NO_STR }, PROP_RNG_X01I },
<span class="lineNum">    1416 </span>                :            :   { &quot;MaxIter&quot;, PROP_INT, { 150, PROP_NO_STR }, PROP_RNGII (2, 10000) },
<span class="lineNum">    1417 </span>                :            :   PROP_NO_PROP };
<span class="lineNum">    1418 </span>                :            : struct define_t hbsolver::anadef =
<span class="lineNum">    1419 </span>                :            :   { &quot;HB&quot;, 0, PROP_ACTION, PROP_NO_SUBSTRATE, PROP_LINEAR, PROP_DEF };
<span class="lineNum">    1420 </span>                :            : 
<span class="lineNum">    1421 </span>                :            : } // namespace qucs
<span class="lineNum">    1422 </span>                :            : 
<span class="lineNum">    1423 </span>                :            : /* TODO list for HB Solver:
<span class="lineNum">    1424 </span>                :            :    - Take care about nodes with non-linear components only.
<span class="lineNum">    1425 </span>                :            :    - AC Power Sources (extra Z and open loop voltage).
<span class="lineNum">    1426 </span>                :            :    - Current sources.
<span class="lineNum">    1427 </span>                :            :    - Balancing of multi-dimensional non-linear networks.
<span class="lineNum">    1428 </span>                :            :    - Sources directly connected to non-linear components and no other
<span class="lineNum">    1429 </span>                :            :      linear component (insert short).
<span class="lineNum">    1430 </span>                :            :    - Bug: With capacitors at hand there is voltage convergence but no
<span class="lineNum">    1431 </span>                :            :      current balancing.
<span class="lineNum">    1432 </span>                :            :    - Output currents through voltage sources.
<span class="lineNum">    1433 </span>                :            :  */
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
